<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工事工程表 Pro - 全期間表示版</title>
    
    <link rel="stylesheet" href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css">
    <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: "メイリオ", sans-serif; }
        .main-container { display: flex; flex-direction: column; height: 100vh; }
        .header-panel { background: #fff; padding: 10px 15px; border-bottom: 1px solid #ccc; display: flex; flex-direction: column; gap: 8px; }
        .input-row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .input-row input { padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
        .btn-add { padding: 6px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .content-area { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 100px; background: #2c3e50; color: #ecf0f1; display: flex; flex-direction: column; border-right: 1px solid #1a252f; }
        .sidebar-title { padding: 10px; font-weight: bold; background: #1a252f; font-size: 13px; cursor: pointer; transition: 0.2s; }
        .sidebar-title:hover { background: #34495e; }
        .project-list { flex: 1; overflow-y: auto; }
        .project-item { padding: 8px 10px; border-bottom: 1px solid #34495e; cursor: pointer; font-size: 14px; transition: 0.2s; font-weight: bold; }
        .project-item:hover { background: #34495e; }
        .project-item.active { background: #3498db; color: white; border-left: 5px solid #fff; }
        .chart-container { flex: 1; display: flex; flex-direction: column; background: #fff; position: relative; overflow: hidden; }

        /* ライトボックスの期間選択を年月日の順に並び替え */
        .gantt_section_time { display: flex !important; flex-wrap: wrap; align-items: center; gap: 5px; }
        .gantt_section_time select:nth-of-type(1) { order: 3; } /* 日 */
        .gantt_section_time select:nth-of-type(2) { order: 2; } /* 月 */
        .gantt_section_time select:nth-of-type(3) { order: 1; } /* 年 */
        .gantt_section_time input, .gantt_section_time span { order: 4; }

        .gantt-layout-container { display: flex; flex-direction: column; flex: 1; min-height: 0; width: 100%; }
        #main.gantt-main { flex: 1; min-height: 0; width: 100%; }
        #resource.gantt-resource { flex: 0 0 260px; min-height: 260px; width: 100%; display: flex; flex-direction: column; border-top: 1px solid #ddd; background: #fff; overflow: hidden; transition: flex 0.2s ease, min-height 0.2s ease; }
        #resource.gantt-resource.resource-panel-closed { flex: 0 0 0; min-height: 0; height: 0; overflow: hidden; border-top: none; }
        .toolbar { background: #f8f9fa; padding: 5px 15px; border-bottom: 1px solid #ddd; display: flex; gap: 10px; align-items: center; font-size: 12px; }
        .zoom-btn { padding: 3px 10px; cursor: pointer; background: #fff; border: 1px solid #ccc; border-radius: 3px; }
        .zoom-btn.active { background-color: #3498db; color: #fff; border-color: #3498db; }
        
        .weekend { background: #f4f4f4 !important; } /* 土日：元の薄いグレー */
        .today-line { background: #ff5252; width: 2px !important; opacity: 0.8; z-index: 1000; }
        .gantt_group_row { background-color: #f0f7ff !important; font-weight: bold !important; } /* 見出し行：さらに薄いスカイブルー */
        
        /* カレンダーの年月を中央揃えにする */
        .gantt_scale_cell { text-align: center !important; }
        
        /* 業務別カラー設定（中程度のパステル調） */
        .task-blue, .gantt_project.task-blue { background-color: #85C1E9 !important; border-color: #5DADE2 !important; }
        .task-green, .gantt_project.task-green { background-color: #82E0AA !important; border-color: #58D68D !important; }
        .task-yellow, .gantt_project.task-yellow { background-color: #F7DC6F !important; border-color: #F4D03F !important; }
        .task-red, .gantt_project.task-red { background-color: #F1948A !important; border-color: #EC7063 !important; }
        .task-orange, .gantt_project.task-orange { background-color: #F8C471 !important; border-color: #F5B041 !important; }
        .task-purple, .gantt_project.task-purple { background-color: #D7BDE2 !important; border-color: #AF7AC5 !important; }
        
        /* 特殊タスク（マイルストーン）のスタイル - 非常に目立つ濃い色を設定 */
        .milestone-circle .gantt_task_content { display: none; }
        .milestone-circle { background: none !important; border: none !important; }
        .milestone-circle::before {
            content: "●";
            color: #d32f2f; /* 濃い赤 */
            font-size: 26px;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .milestone-diamond .gantt_task_content { display: none; }
        .milestone-diamond { background: none !important; border: none !important; }
        .milestone-diamond::before {
            content: "◆";
            color: #1976D2; /* 濃い青 */
            font-size: 28px;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .milestone-star .gantt_task_content { display: none; }
        .milestone-star { background: none !important; border: none !important; }
        .milestone-star::before {
            content: "★";
            color: #2E7D32; /* 濃い緑 */
            font-size: 30px;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        
        /* バー内の文字色（白文字に統一） */
        .gantt_task_content { color: #fff !important; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }

        /* 開始日リサイズハンドル（バー左の三角）を表示・有効化（終了日同様に変更可能にする） */
        .gantt_task_drag[data-bind-property="start_date"] {
            display: block !important;
            visibility: visible !important;
            pointer-events: auto !important;
        }

        .filter-group {
            display: flex;
            gap: 5px;
            align-items: center;
            margin-left: 10px;
            padding-left: 10px;
            border-left: 1px solid #ccc;
        }

        /* カスタムツールチップのスタイル */
        .custom-tooltip {
            position: fixed;
            display: none;
            background: rgba(33, 33, 33, 0.75); /* 透明度をアップ (0.95 -> 0.75) */
            backdrop-filter: blur(4px); /* 背景を少しぼかして文字を読みやすく */
            -webkit-backdrop-filter: blur(4px);
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: bold;
            z-index: 10000;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            white-space: pre-line;
            line-height: 1.5;
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* リソース（下段）＝全体工程表と同じデザイン・土日・今日線を一直線に */
        .resource-header {
            background: #f8f9fa;
            padding: 5px 15px;
            font-weight: bold;
            font-size: 12px;
            color: #2c3e50;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
        }
        .resource-header-close {
            margin-left: 8px;
            padding: 2px 8px;
            border: 1px solid #ccc;
            background: #fff;
            color: #666;
            font-size: 16px;
            line-height: 1;
            cursor: pointer;
            border-radius: 3px;
        }
        .resource-header-close:hover { background: #f0f0f0; color: #333; }
        .resource-content {
            flex: 1;
            overflow: auto;
            padding: 0;
            min-height: 0;
            background: #fff;
        }
        .resource-content-inner {
            display: flex;
            flex-direction: column;
            gap: 0;
            min-width: 1px;
            padding: 0 0 10px 0;
        }
        .resource-item {
            display: flex;
            margin-bottom: 0;
            align-items: center;
            font-size: 12px;
            min-width: min-content;
            min-height: 24px;
            border-bottom: 1px solid #e0e0e0;
        }
        .resource-item:last-child { border-bottom: none; }
        /* 下段グリッド：上段と同じ列幅（GRID_WIDTH=699）でカレンダー開始位置を一致・横スクロール時も固定 */
        .resource-grid-container {
            width: 699px;
            min-width: 699px;
            flex-shrink: 0;
            position: sticky;
            left: 0;
            z-index: 2;
            display: flex;
            background: #f5f5f5;
        }
        .resource-item .resource-grid-container { background: #fff; }
        .resource-grid {
            width: 699px;
            min-width: 699px;
            display: flex;
            flex-shrink: 0;
            background: inherit;
            border-right: 1px solid #e0e0e0;
        }
        .resource-grid .resource-cell {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            padding: 0 4px;
            font-size: 12px;
            border-right: 1px solid #e0e0e0;
            box-sizing: border-box;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .resource-grid .resource-cell:last-child { border-right: none; }
        .resource-scale-row .resource-grid { background: #f5f5f5; }
        .resource-item .resource-grid { background: #fff; }
        .resource-cell-w75 { width: 75px; min-width: 75px; justify-content: center; }
        .resource-cell-w160 { width: 160px; min-width: 160px; }
        .resource-cell-w60 { width: 60px; min-width: 60px; justify-content: center; }
        .resource-cell-w100 { width: 100px; min-width: 100px; }
        .resource-cell-w44 { width: 44px; min-width: 44px; }
        .resource-grid-fill {
            width: 624px;
            min-width: 624px;
            flex-shrink: 0;
            background: #f5f5f5;
            border-right: 1px solid #e0e0e0;
        }
        .resource-scale-label {
            width: 75px;
            min-width: 75px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            padding: 0 4px;
            color: #333;
            font-weight: bold;
            font-size: 12px;
            position: sticky;
            left: 0;
            z-index: 2;
            background: #f5f5f5;
            border-right: 1px solid #e0e0e0;
            box-sizing: border-box;
        }
        .resource-timeline {
            flex: 1;
            min-width: 0;
            position: relative;
            z-index: 0;
            height: 22px;
            background: #fff;
            border-right: 1px solid #e0e0e0;
            /* 右スクロール時、グリッド範囲に入ったバーを完全に非表示にする */
            clip-path: inset(0 0 0 var(--resource-clip-left, 0px));
        }
        .resource-timeline-grid {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 0;
        }
        .resource-timeline-grid-cell {
            position: absolute;
            top: 0;
            bottom: 0;
            border-right: 1px solid #e0e0e0;
            box-sizing: border-box;
        }
        .resource-timeline-grid-cell:last-child { border-right: none; }
        .resource-bar {
            position: absolute;
            z-index: 1;
            height: 100%;
            border-radius: 2px;
            border: 1px solid rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff !important;
            font-size: 11px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            box-sizing: border-box;
        }
        /* 上段ガントと同じ色・枠（リソースバー用） */
        .resource-bar.task-blue { background-color: #85C1E9 !important; border-color: #5DADE2 !important; }
        .resource-bar.task-green { background-color: #82E0AA !important; border-color: #58D68D !important; }
        .resource-bar.task-yellow { background-color: #F7DC6F !important; border-color: #F4D03F !important; }
        .resource-bar.task-red { background-color: #F1948A !important; border-color: #EC7063 !important; }
        .resource-bar.task-orange { background-color: #F8C471 !important; border-color: #F5B041 !important; }
        .resource-bar.task-purple { background-color: #D7BDE2 !important; border-color: #AF7AC5 !important; }
        /* マイルストーン：上段と同じ記号のみ表示 */
        .resource-bar.milestone-circle { background: none !important; border: none !important; }
        .resource-bar.milestone-circle .resource-bar-text { display: none; }
        .resource-bar.milestone-circle::before { content: "●"; color: #d32f2f; font-size: 22px; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .resource-bar.milestone-diamond { background: none !important; border: none !important; }
        .resource-bar.milestone-diamond .resource-bar-text { display: none; }
        .resource-bar.milestone-diamond::before { content: "◆"; color: #1976D2; font-size: 24px; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .resource-bar.milestone-star { background: none !important; border: none !important; }
        .resource-bar.milestone-star .resource-bar-text { display: none; }
        .resource-bar.milestone-star::before { content: "★"; color: #2E7D32; font-size: 26px; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .resource-scale-row { display: flex; align-items: stretch; margin-bottom: 0; font-size: 12px; }
        .resource-scale-row:first-of-type .resource-scale-inner { border-bottom: 1px solid #e0e0e0; }
        .resource-scale-row:last-of-type .resource-scale-inner { height: 24px; }
        .resource-grid-lines-only .resource-scale-inner { height: 10px; min-height: 10px; }
        .resource-grid-lines-only .resource-scale-cell { border-right: 1px solid #e0e0e0; }
        .resource-scale-inner {
            flex: 1;
            min-width: 0;
            position: relative;
            height: 22px;
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-top: none;
            box-sizing: border-box;
        }
        .resource-scale-row:first-of-type .resource-scale-inner { border-top: 1px solid #e0e0e0; }
        .resource-scale-cell {
            position: absolute;
            top: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid #e0e0e0;
            box-sizing: border-box;
            color: #333;
            font-size: 12px;
            text-align: center;
        }
        .resource-scale-cell:last-child { border-right: none; }
        .resource-scale-cell.weekend { background: #f4f4f4 !important; }
        .resource-calendar-wrap { margin-bottom: 4px; }
        .resource-today-line { position: absolute; top: 0; bottom: 0; width: 2px; background: #ff5252; opacity: 0.8; z-index: 10; pointer-events: none; }
        .resource-today-wrap { position: relative; }
        .resource-today-row .resource-scale-inner { background: transparent; border: none; }
        .resource-placeholder { padding: 24px; color: #999; text-align: center; font-size: 13px; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header-panel">
            <div class="input-row">
                <input type="text" id="project_number" placeholder="工事番号" style="width:100px">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="font-size: 12px; color: #666;">受注日:</span>
                    <input type="date" id="order_date" title="受注日">
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="font-size: 12px; color: #666;">出荷日:</span>
                    <input type="date" id="shipping_date" title="出荷日">
                </div>
                <button class="btn-add" onclick="addProjectFromTemplate()">新規追加</button>
                <span style="margin-left: 15px; font-size: 13px; font-weight: bold; color: #333;">
                    <span style="color: #d32f2f; font-size: 20px;">●</span> 外観検査
                    <span style="margin-left: 10px; color: #1976D2; font-size: 20px;">◆</span> 出荷確認会議
                    <span style="margin-left: 10px; color: #2E7D32; font-size: 22px;">★</span> 工場出荷
                </span>
                <span id="save-status" style="font-size:11px; color:#999; margin-left:10px;"></span>
            </div>
        </div>

        <div class="toolbar">
            <div class="filter-group" style="margin-left: 0; padding-left: 0; border-left: none;">
                <span>大項目フィルタ:</span>
                <button class="zoom-btn major-filter-btn" onclick="filterByMajorItem('営業', this)">営業</button>
                <button class="zoom-btn major-filter-btn" onclick="filterByMajorItem('設計', this)">設計</button>
                <button class="zoom-btn major-filter-btn" onclick="filterByMajorItem('製管', this)">製管</button>
                <button class="zoom-btn major-filter-btn" onclick="filterByMajorItem('組立', this)">組立</button>
                <button class="zoom-btn major-filter-btn" onclick="filterByMajorItem('電装', this)">電装</button>
                <button class="zoom-btn major-filter-btn" onclick="filterByMajorItem('品証', this)">品証</button>
                <button class="zoom-btn major-filter-btn" onclick="filterByMajorItem('操業', this)">操業</button>
            </div>

            <div class="filter-group">
                <span>機械検索:</span>
                <input type="text" id="machine_search" placeholder="機械名を入力..." style="width:100px; padding:3px; border:1px solid #ccc; border-radius:3px; font-size:12px;" oninput="filterByMachine(this.value)">
            </div>

            <div class="filter-group">
                <span>担当検索:</span>
                <input type="text" id="owner_search" placeholder="名前を入力..." style="width:100px; padding:3px; border:1px solid #ccc; border-radius:3px; font-size:12px;" oninput="filterByOwner(this.value)">
            </div>

            <div class="filter-group">
                <span>リソース（担当者）:</span>
                <input type="text" id="resource_owner_input" placeholder="担当名を入力..." style="width:120px; padding:3px; border:1px solid #ccc; border-radius:3px; font-size:12px;" oninput="showResourceViewByOwner(this.value)">
            </div>

            <div style="margin-left:auto; display:flex; align-items:center; gap:10px;">
                <span>表示切替:</span>
                <button class="zoom-btn" onclick="setZoom('days')">日単位</button>
                <button class="zoom-btn" onclick="setZoom('weeks')">週単位</button>
                <button class="zoom-btn" onclick="scrollToToday()" style="background-color: #ebf5ff; border-color: #3498db; color: #3498db;">今日へ移動</button>
                <span id="filter_status" style="font-weight:bold; color:#3498db;">全工程を表示中</span>
                <button class="zoom-btn" onclick="resetFilter()">表示リセット</button>
            </div>
        </div>

        <div class="content-area">
            <div class="sidebar">
                <div class="sidebar-title" onclick="resetFilter()" title="クリックして全表示にリセット">工事一覧</div>
                <div id="project_list" class="project-list"></div>
            </div>
            <div class="chart-container">
                <!-- 上段 main / 下段 resource の2段レイアウト（gantt.config.layout の代わりに同一コンテナで分割） -->
                <div id="gantt_layout_container" class="gantt-layout-container">
                    <div id="main" class="gantt-main"></div>
                    <div id="resource" class="gantt-resource resource-panel-closed">
                        <div class="resource-header">
                            <span id="resource_title">リソース状況（担当者で選択）</span>
                            <button type="button" class="resource-header-close" id="resource_close_btn" title="リソース画面を閉じる" aria-label="閉じる">×</button>
                        </div>
                        <div id="resource_content" class="resource-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const S_URL = "https://dgekjzkrybrswsxlcbvh.supabase.co";
        const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRnZWtqemtyeWJyc3dzeGxjYnZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4ODQ3MjIsImV4cCI6MjA4NDQ2MDcyMn0.BsEj53lV3p76yE9fMPTaLn7ocKTNzYPTqIAnBafYItU";
        const supabaseClient = supabase.createClient(S_URL, S_KEY);

        let currentFilter = null;
        let currentMajorFilter = null;
        let currentOwnerFilter = "";
        let currentMachineFilter = "";
        const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
        const dateToDb = gantt.date.date_to_str("%Y-%m-%d");
        const dateToDisplay = gantt.date.date_to_str("%Y/%m/%d");

        // 上段・下段で共通のグリッド幅・列幅（カレンダー位置を完全一致させるため）
        const GRID_WIDTH = 699;
        const COLUMN_WIDTHS = [75, 160, 60, 60, 100, 100, 100, 44]; // 工事番号, タスク名, 機械, ユニット, 担当, 開始日, 終了日, add

        // 表示期間（上段・下段で同一にし、ズレを防ぐ）
        const GANTT_START_DATE = new Date(2024, 10, 1);  // 2024/11/1
        const GANTT_END_DATE = new Date(2027, 11, 0);   // 2027/11/30（11月末）

        gantt.plugins({ marker: true, grouplist: true });
        
        gantt.config.start_date = new Date(GANTT_START_DATE.getTime());
        gantt.config.end_date = new Date(GANTT_END_DATE.getTime());
        gantt.config.fit_tasks = false; // タスクの有無に関わらず設定期間を維持（下段が10月で終わらないように）
        gantt.config.include_empty_scales = true; // タスクがない期間もカレンダーを表示する
        gantt.config.date_format = "%Y-%m-%d";
        gantt.config.date_grid = "%Y/%m/%d";

        // 上下2段レイアウト：上段 #main（全体工程表）、下段 #resource（リソース）は HTML の gantt_layout_container で分割
        // カレンダー・ズーム・横スクロールは上下で常に一致させる

        // カレンダー範囲の強制適用（上段・下段で同じ期間を維持）
        gantt.attachEvent("onBeforeGanttRender", function(){
            gantt.config.start_date = new Date(GANTT_START_DATE.getTime());
            gantt.config.end_date = new Date(GANTT_END_DATE.getTime());
            gantt.config.fit_tasks = false;
        });
        // ガント再描画後、下段に内容があればスクロール・ズーム同期を再設定
        gantt.attachEvent("onAfterGanttRender", function(){
            var rc = document.getElementById('resource_content');
            if (rc && rc.firstElementChild && rc.firstElementChild.classList.contains('resource-content-inner')) {
                setTimeout(function(){ setupResourceGanttScrollSync(); }, 50);
            }
        });

        gantt.config.columns = [
            { name: "project_number", label: "工事番号", width: COLUMN_WIDTHS[0], align: "center", template: function(obj) {
                return obj.project_number || ""; 
            }},
            { name: "text", label: "タスク名", width: COLUMN_WIDTHS[1], tree: true, template: function(obj) {
                return obj.text;
            }},
            { name: "machine", label: "機械", width: COLUMN_WIDTHS[2], align: "center", template: function(obj) {
                if (obj.$virtual) return "";
                return obj.machine || "";
            }},
            { name: "unit", label: "ユニット", width: COLUMN_WIDTHS[3], align: "center", template: function(obj) {
                if (obj.$virtual) return "";
                return obj.unit || "";
            }},
            { name: "owner", label: "担当", width: COLUMN_WIDTHS[4], align: "left", template: function(obj) {
                if (obj.$virtual || !obj.owner) return "";
                return obj.owner.replace(/\d+/g, ""); // すべての数字を削除
            }},
            { name: "start_date", label: "開始日", width: COLUMN_WIDTHS[5], align: "center", template: (t) => {
                return dateToDisplay(t.start_date);
            }},
            { name: "end_date", label: "終了日", width: COLUMN_WIDTHS[6], align: "center", template: (t) => {
                return dateToDisplay(gantt.calculateEndDate(t.start_date, t.duration));
            }},
            { name: "add", label: "", width: COLUMN_WIDTHS[7] }
        ];
        gantt.config.grid_width = GRID_WIDTH;
        gantt.config.grid_resize = false; // グリッド境界のドラッグで幅を変えるとズレるため無効化
        gantt.config.drag_resize = true;   // バー両端の三角で開始日・終了日を変更可能に
        gantt.config.row_height = 30; // 行の高さを少し狭く設定 (デフォルトは約35〜38px)
        gantt.config.open_tree_initially = false; // 最初は閉じておく
        gantt.config.order_branch = true; // ドラッグによる並べ替えを有効化
        gantt.config.order_branch_free = true;

        // 大項目の選択肢リスト
        const parentOptions = [
            { key: "", label: "なし" },
            { key: "受注", label: "受注" },
            { key: "基本設計＆計画承認", label: "基本設計＆計画承認" },
            { key: "部品手配1", label: "部品手配1" },
            { key: "出図＆部品手配2", label: "出図＆部品手配2" },
            { key: "電気設計", label: "電気設計" },
            { key: "盤組立", label: "盤組立" },
            { key: "組立全体", label: "組立全体" },
            { key: "外観検査", label: "外観検査" },
            { key: "タスクリスト作成", label: "タスクリスト作成" },
            { key: "試運転", label: "試運転" },
            { key: "客先立会", label: "客先立会" },
            { key: "出荷確認会議", label: "出荷確認会議" },
            { key: "出荷準備", label: "出荷準備" },
            { key: "出荷", label: "出荷" },
            { key: "現地工事", label: "現地工事" }
        ];

        // 詳細編集画面（ライトボックス）の設定
        gantt.config.lightbox.sections = [
            { name: "description", height: 70, map_to: "text", type: "textarea", focus: true },
            { name: "parent_name", height: 30, map_to: "parent_name", type: "select", options: parentOptions }, // セレクトボックスに変更
            { name: "project_number", height: 30, map_to: "project_number", type: "textarea" },
            { name: "machine", height: 30, map_to: "machine", type: "textarea" },
            { name: "unit", height: 30, map_to: "unit", type: "textarea" },
            { name: "major_item", height: 30, map_to: "major_item", type: "select", options: [
                { key: "", label: "なし" },
                { key: "設計", label: "設計" },
                { key: "製管", label: "製管" },
                { key: "組立", label: "組立" },
                { key: "電装", label: "電装" },
                { key: "品証", label: "品証" },
                { key: "操業", label: "操業" },
                { key: "営業", label: "営業" }
            ]},
            { name: "customer_name", height: 30, map_to: "customer_name", type: "textarea" },
            { name: "project_details", height: 30, map_to: "project_details", type: "textarea" },
            { name: "owner", height: 30, map_to: "owner", type: "textarea" },
            { name: "time", height: 72, type: "duration", map_to: "auto" }
        ];
        gantt.config.lightbox.time_format = "%Y/%m/%d";
        gantt.locale.labels.section_parent_name = "大項目名(見出し)";
        gantt.locale.labels.section_project_number = "工事番号";
        gantt.locale.labels.section_machine = "機械名";
        gantt.locale.labels.section_unit = "ユニット";
        gantt.locale.labels.section_major_item = "色分け(業務)";
        gantt.locale.labels.section_customer_name = "客先名";
        gantt.locale.labels.section_project_details = "工事内容";
        gantt.locale.labels.section_description = "タスク名";
        gantt.locale.labels.section_owner = "担当";
        gantt.locale.labels.section_time = "期間";

        // ＋ボタンの挙動をカスタマイズ（親の情報を引き継ぐ）
        gantt.attachEvent("onTaskCreated", function(task){
            if (task.parent) {
                const parentTask = gantt.getTask(task.parent);
                if (parentTask.$virtual) {
                    task.project_number = parentTask.project_number;
                    task.parent_name = parentTask.text; // きれいな名前を引き継ぐ
                    task.customer_name = parentTask.customer_name;
                    task.project_details = parentTask.project_details;
                }
            }
            return true;
        });

        gantt.templates.grid_row_class = function(start, end, task){
            if(task.$virtual) return "gantt_group_row";
            return "";
        };

        gantt.templates.task_row_class = function(start, end, task){
            return "";
        };

        // フィルタ設定：工事番号、大項目、担当名、機械名の絞り込み
        gantt.attachEvent("onBeforeTaskDisplay", function(id, task){
            // 見出し行（仮想タスク）の場合の処理
            if (task.$virtual) {
                // 1. 工事番号フィルタが適用されている場合、その工事番号以外の見出しは非表示
                if (currentFilter && !task.id.startsWith(`p_${currentFilter}_`)) {
                    return false;
                }
                // 2. 大項目フィルタが適用されている場合、見出しの major_item が一致しない場合は非表示
                if (currentMajorFilter && task.major_item !== currentMajorFilter) {
                    return false;
                }
                return true;
            }
            
            // 通常タスクのフィルタ
            if (currentFilter && task.project_number !== currentFilter) return false;
            if (currentMajorFilter && task.major_item !== currentMajorFilter) return false;
            if (currentOwnerFilter && (!task.owner || !task.owner.includes(currentOwnerFilter))) return false;
            if (currentMachineFilter && (!task.machine || !task.machine.includes(currentMachineFilter))) return false;
            return true;
        });

        // 今日のマーカー
        gantt.addMarker({ start_date: new Date(), css: "today-line", text: "今日" });

        // 業務別（major_item）および特殊タスク（text）の色分け・マークテンプレート
        gantt.templates.task_class = function(start, end, task) {
            if (task.text === "外観検査") return "milestone-circle";
            if (task.text === "出荷確認会議") return "milestone-diamond";
            if (task.text === "工場出荷") return "milestone-star";

            switch (task.major_item) {
                case '設計': return "task-blue";
                case '製管':
                case '品証': return "task-green";
                case '組立': return "task-yellow";
                case '電装': return "task-purple";
                case '操業': return "task-red";
                case '営業': return "task-orange";
                default: return "";
            }
        };
        
        gantt.templates.timeline_cell_class = (task, date) => (date.getDay() === 0 || date.getDay() === 6) ? "weekend" : "";
        
        const zoomConfig = {
            levels: [
                { name: "days", scale_height: 75, min_column_width: 25, scales: [
                    { unit: "month", step: 1, format: "%Y/%n" },
                    { unit: "day", step: 1, format: "%j" }, 
                    { unit: "day", step: 1, format: (date) => dayNames[date.getDay()] }
                ]},
                { name: "weeks", scale_height: 50, min_column_width: 25, scales: [
                    { unit: "month", step: 1, format: "%Y/%n" },
                    { unit: "week", step: 1, format: (date) => {
                        const dateToStr = gantt.date.date_to_str("%j");
                        return dateToStr(date);
                    }}
                ]}
            ]
        };
        gantt.ext.zoom.init(zoomConfig);
        gantt.init("main");

        // メインガントの横スクロール要素を取得（上段 #main 内のタイムライン部分）
        function getGanttScrollElement() {
            var root = document.getElementById('main');
            if (!root) return null;
            var best = null;
            var walk = function(el) {
                if (!el || el.id === 'resource_panel') return;
                var style = window.getComputedStyle(el);
                var overflowX = style.overflowX || style.overflow;
                var canScroll = el.scrollWidth > el.clientWidth && (overflowX === 'auto' || overflowX === 'scroll' || overflowX === 'overlay');
                if (canScroll && !best) best = el;
                for (var i = 0; i < el.children.length; i++) walk(el.children[i]);
            };
            walk(root);
            return best;
        }

        // メインガントのカレンダー列幅（px）を取得（リソース画面の列幅を合わせるため）
        function getGanttColumnWidth() {
            var root = document.getElementById('main');
            if (!root) return 25;
            var cell = root.querySelector('.gantt_scale_cell');
            if (cell && cell.offsetWidth > 0) return cell.offsetWidth;
            return 25;
        }
        // 現在のズームが週単位かどうか（0=日単位, 1=週単位）
        function isGanttWeekZoom() {
            try {
                var level = gantt.ext.zoom.getLevel();
                return level === 1 || level === "weeks";
            } catch (e) { return true; }
        }

        // リソースパネルとメインガントの横スクロールを連動（同一時間軸・双方向同期）
        var resourceGanttSyncLock = false;
        var _ganttScrollElAttached = null;
        var _resourceContentAttached = null;
        function _syncFromGantt() {
            if (resourceGanttSyncLock) return;
            var ge = getGanttScrollElement(), rc = document.getElementById('resource_content');
            if (!ge || !rc || !rc.firstElementChild) return;
            resourceGanttSyncLock = true;
            // 下段のタイムライン幅を上段と同一にしているので 1:1 で同期（2024/11～2027/11 の範囲で完全一致）
            rc.scrollLeft = ge.scrollLeft;
            resourceGanttSyncLock = false;
            // グリッド範囲に入ったバーを完全に非表示
            rc.style.setProperty('--resource-clip-left', rc.scrollLeft + 'px');
        }
        function _syncFromResource() {
            if (resourceGanttSyncLock) return;
            var ge = getGanttScrollElement(), rc = document.getElementById('resource_content');
            if (!ge || !rc) return;
            resourceGanttSyncLock = true;
            ge.scrollLeft = rc.scrollLeft;
            resourceGanttSyncLock = false;
            // グリッド範囲に入ったバーを完全に非表示（タイムラインをスクロール量でクリップ）
            rc.style.setProperty('--resource-clip-left', rc.scrollLeft + 'px');
        }
        function setupResourceGanttScrollSync() {
            var ganttEl = getGanttScrollElement();
            var resourceContent = document.getElementById('resource_content');
            if (!ganttEl || !resourceContent || !resourceContent.firstElementChild) return;
            if (_ganttScrollElAttached) _ganttScrollElAttached.removeEventListener('scroll', _syncFromGantt);
            if (_resourceContentAttached) _resourceContentAttached.removeEventListener('scroll', _syncFromResource);
            _ganttScrollElAttached = ganttEl;
            _resourceContentAttached = resourceContent;
            ganttEl.addEventListener('scroll', _syncFromGantt);
            resourceContent.addEventListener('scroll', _syncFromResource);
            _syncFromGantt();
        }

        // 入力した担当名で owner を検索し、下段に表示
        function showResourceViewByOwner(ownerValue) {
            showResourceView(ownerValue || "", true);
        }

        async function fetchTasks() {
            // 並び順（sort_order）で取得
            const { data, error } = await supabaseClient.from('tasks').select('*').order('sort_order', { ascending: true });
            if (error) return;
            
            const rawTasks = data.map(t => ({
                id: t.id, text: t.text, start_date: t.start_date,
                duration: t.duration, owner: t.owner, project_number: (t.project_number || "").toString().trim(),
                machine: t.machine, unit: t.unit, major_item: t.major_item,
                sort_order: t.sort_order,
                parent_name: (t.parent || "").toString().trim(), // 空白を除去して保持
                customer_name: t.customer_name || "",
                project_details: t.project_details || ""
            }));

            // 指定された大項目の並び順
            const parentOrder = [
                "受注", "基本設計＆計画承認", "部品手配1", "出図＆部品手配2", 
                "電気設計", "盤組立", "組立全体", "外観検査", "タスクリスト作成", 
                "試運転", "客先立会", "出荷確認会議", "出荷準備", "出荷", "現地工事"
            ];

            const tasksWithHierarchy = [];
            const parentsMap = {};

            // 1. 工事番号を特定のルールでソートして取得
            const getPriority = (p) => {
                if (p.startsWith('2')) return 1;
                if (p.startsWith('3')) return 2;
                if (p.startsWith('4')) return 3;
                if (p.startsWith('D')) return 4;
                return 5;
            };
            const isPureNumeric = (s) => /^\d+$/.test(s);

            const projects = [...new Set(rawTasks.map(t => t.project_number))]
                .filter(Boolean)
                .sort((a, b) => {
                    const priA = getPriority(a);
                    const priB = getPriority(b);
                    if (priA !== priB) return priA - priB;
                    const numA = isPureNumeric(a);
                    const numB = isPureNumeric(b);
                    if (numA && !numB) return -1;
                    if (!numA && numB) return 1;
                    return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
                });

            projects.forEach(pNum => {
                const projectTasks = rawTasks.filter(t => t.project_number === pNum);
                
                parentOrder.forEach(pName => {
                    const tasksInParent = projectTasks.filter(t => t.parent_name === pName);
                    if (tasksInParent.length > 0) {
                        const parentKey = `p_${pNum}_${pName}`;
                        
                        let minStart = null;
                        let maxEnd = null;
                        tasksInParent.forEach(t => {
                            const start = new Date(t.start_date);
                            const end = gantt.calculateEndDate(start, t.duration);
                            if (!minStart || start < minStart) minStart = start;
                            if (!maxEnd || end > maxEnd) maxEnd = end;
                        });

                        if (!parentsMap[parentKey]) {
                            parentsMap[parentKey] = {
                                id: parentKey,
                                text: pName,
                                project_number: pNum,
                                machine: tasksInParent[0].machine,
                                major_item: tasksInParent[0].major_item,
                                customer_name: tasksInParent[0].customer_name,
                                project_details: tasksInParent[0].project_details,
                                start_date: minStart,
                                end_date: maxEnd,
                                open: false,
                                type: "project",
                                $virtual: true
                            };
                            tasksWithHierarchy.push(parentsMap[parentKey]);
                        }
                        tasksInParent.forEach(t => {
                            t.parent = parentKey;
                            tasksWithHierarchy.push(t);
                        });
                    }
                });

                const otherTasks = projectTasks.filter(t => t.parent_name && !parentOrder.includes(t.parent_name));
                const otherParentNames = [...new Set(otherTasks.map(t => t.parent_name))];
                otherParentNames.forEach(pName => {
                    const tasksInParent = otherTasks.filter(t => t.parent_name === pName);
                    if (tasksInParent.length > 0) {
                        const parentKey = `p_${pNum}_${pName}`;
                        if (!parentsMap[parentKey]) {
                            parentsMap[parentKey] = {
                                id: parentKey, text: pName, project_number: pNum,
                                machine: tasksInParent[0].machine, major_item: tasksInParent[0].major_item,
                                customer_name: tasksInParent[0].customer_name,
                                project_details: tasksInParent[0].project_details,
                                open: false, type: "project", $virtual: true
                            };
                            tasksWithHierarchy.push(parentsMap[parentKey]);
                        }
                        tasksInParent.forEach(t => {
                            t.parent = parentKey;
                            tasksWithHierarchy.push(t);
                        });
                    }
                });

                const noParentTasks = projectTasks.filter(t => !t.parent_name);
                noParentTasks.forEach(t => {
                    t.parent = 0;
                    tasksWithHierarchy.push(t);
                });
            });

            updateProjectList(rawTasks);
            gantt.clearAll();
            gantt.parse({ data: tasksWithHierarchy });
            // カレンダー範囲の強制適用（parse 後も 2027/11 まで維持）
            gantt.config.start_date = new Date(GANTT_START_DATE.getTime());
            gantt.config.end_date = new Date(GANTT_END_DATE.getTime());
            gantt.config.fit_tasks = false;
            gantt.render();
            // 初期表示位置を今日の日付に合わせ、上段・下段のスクロールを同期
            scrollToToday();
            setTimeout(function() {
                var rc = document.getElementById('resource_content');
                if (rc && rc.firstElementChild && rc.firstElementChild.classList.contains('resource-content-inner')) {
                    setupResourceGanttScrollSync();
                    _syncFromGantt();
                }
            }, 100);
        }

        function scrollToToday() {
            const pos = gantt.posFromDate(new Date());
            gantt.scrollTo(pos - 200, null);
        }

        function setZoom(level) { 
            gantt.ext.zoom.setLevel(level); 
            gantt.config.start_date = new Date(GANTT_START_DATE.getTime());
            gantt.config.end_date = new Date(GANTT_END_DATE.getTime());
            gantt.config.fit_tasks = false;
            gantt.render();
            var inp = document.getElementById('resource_owner_input');
            if (inp && inp.value.trim()) showResourceViewByOwner(inp.value);
        }

        function updateProjectList(tasks) {
            const listEl = document.getElementById('project_list');
            
            // 工事番号ごとの案件情報を収集
            const projectInfoMap = {};
            tasks.forEach(t => {
                if (t.project_number && !projectInfoMap[t.project_number]) {
                    // その工事番号の最初のタスクから客先名と工事内容を取得
                    projectInfoMap[t.project_number] = {
                        customer: t.customer_name || "",
                        details: t.project_details || ""
                    };
                }
            });

            const projects = Object.keys(projectInfoMap).sort();
            listEl.innerHTML = "";

            // ツールチップ要素の取得または作成
            let tooltip = document.getElementById('custom_project_tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'custom_project_tooltip';
                tooltip.className = 'custom-tooltip';
                document.body.appendChild(tooltip);
            }

            projects.forEach(p => {
                const item = document.createElement('div');
                item.className = `project-item ${currentFilter === p ? 'active' : ''}`;
                item.innerText = p;
                
                // カスタム吹き出しの設定
                const info = projectInfoMap[p];
                if (info.customer || info.details) {
                    const tooltipText = `${info.customer}\n${info.details}`.trim();
                    
                    item.onmouseenter = (e) => {
                        tooltip.innerText = tooltipText;
                        tooltip.style.display = 'block';
                        // 表示位置を固定（マウスが入った瞬間の位置にセット）
                        tooltip.style.left = (e.clientX + 15) + 'px';
                        tooltip.style.top = (e.clientY + 10) + 'px';
                    };
                    item.onmouseleave = () => {
                        tooltip.style.display = 'none';
                    };
                }

                item.onclick = () => filterByProject(p);
                listEl.appendChild(item);
            });
        }

        function filterByProject(p) {
            if (currentFilter === p) {
                currentFilter = null;
            } else {
                currentFilter = p;
            }
            updateFilterStatus();
            gantt.config.start_date = new Date(GANTT_START_DATE.getTime());
            gantt.config.end_date = new Date(GANTT_END_DATE.getTime());
            gantt.config.fit_tasks = false;
            gantt.render();
            const allTasks = gantt.getDatastore("task").getItems().filter(t => !t.$virtual);
            updateProjectList(allTasks);
        }

        function filterByMajorItem(major, btn) {
            if (currentMajorFilter === major) {
                currentMajorFilter = null;
                btn.classList.remove('active');
            } else {
                currentMajorFilter = major;
                document.querySelectorAll('.major-filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            updateFilterStatus();
            gantt.config.start_date = new Date(GANTT_START_DATE.getTime());
            gantt.config.end_date = new Date(GANTT_END_DATE.getTime());
            gantt.config.fit_tasks = false;
            gantt.render();
        }

        function filterByOwner(val) {
            currentOwnerFilter = val;
            updateFilterStatus();
            gantt.config.start_date = new Date(GANTT_START_DATE.getTime());
            gantt.config.end_date = new Date(GANTT_END_DATE.getTime());
            gantt.config.fit_tasks = false;
            gantt.render();
        }

        function filterByMachine(val) {
            currentMachineFilter = val;
            updateFilterStatus();
            gantt.config.start_date = new Date(GANTT_START_DATE.getTime());
            gantt.config.end_date = new Date(GANTT_END_DATE.getTime());
            gantt.config.fit_tasks = false;
            gantt.render();
        }

        function updateFilterStatus() {
            let status = "";
            let parts = [];
            if (currentFilter) parts.push(`工事 ${currentFilter}`);
            if (currentMajorFilter) parts.push(currentMajorFilter);
            if (currentMachineFilter) parts.push(`機械: ${currentMachineFilter}`);
            if (currentOwnerFilter) parts.push(`担当: ${currentOwnerFilter}`);
            status = parts.length > 0 ? parts.join(" / ") + " を表示中" : "全工程を表示中";
            document.getElementById('filter_status').innerText = status;
        }

        function resetFilter() {
            currentFilter = null;
            currentMajorFilter = null;
            currentOwnerFilter = "";
            currentMachineFilter = "";
            document.getElementById('owner_search').value = "";
            document.getElementById('machine_search').value = "";
            var inp = document.getElementById('resource_owner_input');
            if (inp) inp.value = "";
            showResourceView("", true);
            document.querySelectorAll('.major-filter-btn').forEach(b => b.classList.remove('active'));
            updateFilterStatus();
            fetchTasks();
        }

        // リソース画面を開く（×で閉じた後に検索した時にすぐ表示するため）
        function openResourcePanel() {
            var panel = document.getElementById('resource');
            if (panel) panel.classList.remove('resource-panel-closed');
        }
        // リソース画面を閉じる（×ボタン用）
        function closeResourcePanel() {
            var panel = document.getElementById('resource');
            if (panel) panel.classList.add('resource-panel-closed');
            var inp = document.getElementById('resource_owner_input');
            if (inp) { inp.value = ""; }
        }

        (function initResourceCloseButton() {
            var btn = document.getElementById('resource_close_btn');
            if (btn) btn.addEventListener('click', closeResourcePanel);
        })();

        // リソース画面の表示ロジック（担当者セレクトで選択した owner のタスクのみ表示）
        function showResourceView(ownerName, fromSelect) {
            var content = document.getElementById('resource_content');
            var title = document.getElementById('resource_title');
            if (!content || !title) return;

            var searchName = (ownerName || "").trim().toLowerCase();
            if (searchName) openResourcePanel();
            if (!searchName) {
                title.innerText = "リソース状況（担当者）";
                content.innerHTML = '<div class="resource-placeholder">担当名を入力してください</div>';
                return;
            }

            var rawData = [];
            try { rawData = (gantt.serialize().data || []); } catch (e) {}

            var tasks = rawData.filter(function(t) {
                if (t.$virtual || !t.owner) return false;
                var o = (t.owner || "").trim().toLowerCase();
                var display = (t.owner || "").replace(/\d+/g, "").trim().toLowerCase();
                return o.indexOf(searchName) !== -1 || display.indexOf(searchName) !== -1;
            });

            title.innerText = "【" + (ownerName || "").trim() + "】のリソース状況 (" + tasks.length + "件のタスク)";
            content.innerHTML = "";

            if (tasks.length === 0) {
                content.innerHTML = '<div class="resource-placeholder">該当する担当者のタスクが見つかりません。</div>';
                return;
            }

            // 下段リソースビューも上段と同じ表示期間・fit_tasks で初期化
            gantt.config.start_date = new Date(GANTT_START_DATE.getTime());
            gantt.config.end_date = new Date(GANTT_END_DATE.getTime());
            gantt.config.fit_tasks = false;

            var ganttStart = gantt.config.start_date.getTime();
            var ganttEnd = gantt.config.end_date.getTime();

            var isWeek = isGanttWeekZoom();
            var cellCount;
            var timelineStartMs = ganttStart;
            var timelineEndMs = ganttEnd;
            if (isWeek) {
                var startDate = new Date(ganttStart);
                var daysToMonday = (startDate.getDay() + 6) % 7;
                var firstMonday = gantt.date.add(startDate, -daysToMonday, 'day');
                timelineStartMs = firstMonday.getTime();
                cellCount = 0;
                for (var d = new Date(firstMonday.getTime()); d.getTime() < ganttEnd; d = gantt.date.add(d, 7, 'day')) cellCount++;
                timelineEndMs = timelineStartMs + cellCount * 7 * 24 * 60 * 60 * 1000;
            } else {
                cellCount = Math.ceil((ganttEnd - ganttStart) / (24 * 60 * 60 * 1000));
            }
            // リソース画面のカレンダー列幅は25pxで固定
            var resourceColWidthPx = 25;
            var timelineMinWidth = Math.max(400, cellCount * resourceColWidthPx);

            var wrapper = document.createElement('div');
            wrapper.className = 'resource-content-inner';
            wrapper.style.minWidth = (GRID_WIDTH + timelineMinWidth) + 'px';
            wrapper.setAttribute('data-resource-timeline-width', timelineMinWidth);
            var timelineRangeMs = timelineEndMs - timelineStartMs;
            var widthPct = cellCount > 0 ? (100 / cellCount) : 0;
            var gridCellsHtml = '';
            for (var c = 0; c < cellCount; c++) {
                gridCellsHtml += '<div class="resource-timeline-grid-cell" style="left:' + (c * widthPct) + '%;width:' + widthPct + '%"></div>';
            }

            for (var i = 0; i < tasks.length; i++) {
                var t = tasks[i];
                var item = document.createElement('div');
                item.className = "resource-item";
                var startDate = t.start_date instanceof Date ? t.start_date : new Date(t.start_date);
                var endDate = gantt.calculateEndDate(startDate, t.duration);
                var startPos = timelineRangeMs > 0 ? ((startDate.getTime() - timelineStartMs) / timelineRangeMs) * 100 : 0;
                var endPos = timelineRangeMs > 0 ? ((endDate.getTime() - timelineStartMs) / timelineRangeMs) * 100 : 0;
                var taskClass = getResourceTaskClass(t);
                var isMilestone = (taskClass === "milestone-circle" || taskClass === "milestone-diamond" || taskClass === "milestone-star");
                var width = isMilestone ? 0.8 : Math.max(0.5, endPos - startPos);
                var safe = function(s) { return (s || "").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;"); };
                var proj = safe(t.project_number);
                var text = safe(t.text);
                var machine = safe(t.machine);
                var unit = safe(t.unit);
                var owner = safe((t.owner || "").replace(/\d+/g, ""));
                var startStr = dateToDisplay(startDate);
                var endStr = dateToDisplay(endDate);
                var barClasses = "resource-bar " + (taskClass || "");
                var barStyle = "left: " + startPos + "%; width: " + width + "%";
                if (!taskClass) {
                    var fallbackColor = getBarColor(t.major_item) || "#ccc";
                    barStyle += "; background-color: " + fallbackColor + "; border-color: rgba(0,0,0,0.2)";
                }
                var barContent = '<span class="resource-bar-text">' + text + '</span>';
                item.innerHTML =
                    '<div class="resource-grid-container"><div class="resource-grid">' +
                    '<div class="resource-cell resource-cell-w75" title="' + proj + '">' + proj + '</div>' +
                    '<div class="resource-cell resource-cell-w160" title="' + text + '">' + text + '</div>' +
                    '<div class="resource-cell resource-cell-w60">' + machine + '</div>' +
                    '<div class="resource-cell resource-cell-w60">' + unit + '</div>' +
                    '<div class="resource-cell resource-cell-w100">' + owner + '</div>' +
                    '<div class="resource-cell resource-cell-w100">' + startStr + '</div>' +
                    '<div class="resource-cell resource-cell-w100">' + endStr + '</div>' +
                    '<div class="resource-cell resource-cell-w44"></div>' +
                    '</div></div>' +
                    '<div class="resource-timeline">' +
                    '<div class="resource-timeline-grid">' + gridCellsHtml + '</div>' +
                    '<div class="' + barClasses + '" style="' + barStyle + '">' + barContent + '</div>' +
                    '</div>';
                wrapper.appendChild(item);
            }
            content.appendChild(wrapper);

            setTimeout(function() {
                setupResourceGanttScrollSync();
                _syncFromGantt();
            }, 50);
        }

        function getBarColor(major) {
            const colors = { '設計': '#85C1E9', '製管': '#82E0AA', '品証': '#82E0AA', '組立': '#F7DC6F', '電装': '#D7BDE2', '操業': '#F1948A', '営業': '#F8C471' };
            return colors[major] || '#ccc';
        }

        // 上段ガントの task_class と同じ分類（リソースバーの見た目用）
        function getResourceTaskClass(task) {
            if (task.text === "外観検査") return "milestone-circle";
            if (task.text === "出荷確認会議") return "milestone-diamond";
            if (task.text === "工場出荷") return "milestone-star";
            switch (task.major_item) {
                case '設計': return "task-blue";
                case '製管': case '品証': return "task-green";
                case '組立': return "task-yellow";
                case '電装': return "task-purple";
                case '操業': return "task-red";
                case '営業': return "task-orange";
                default: return "";
            }
        }

        // 下段用：区切り用の縦線のみ（日付ラベルなし）を生成
        function buildResourceGridLines(ganttStartMs, ganttEndMs, isWeekView) {
            var startDate = new Date(ganttStartMs);
            var totalMs = ganttEndMs - ganttStartMs;
            if (totalMs <= 0) return document.createElement('div');

            var cellCount;
            if (isWeekView) {
                var daysToMonday = (startDate.getDay() + 6) % 7;
                var firstMonday = gantt.date.add(startDate, -daysToMonday, 'day');
                cellCount = 0;
                for (var d = new Date(firstMonday.getTime()); d.getTime() < ganttEndMs; d = gantt.date.add(d, 7, 'day')) cellCount++;
            } else {
                cellCount = Math.ceil(totalMs / (24 * 60 * 60 * 1000));
            }
            if (cellCount === 0) return document.createElement('div');

            var widthPct = 100 / cellCount;

            var row = document.createElement('div');
            row.className = 'resource-scale-row resource-grid-lines-only';
            var gridContainer = document.createElement('div');
            gridContainer.className = 'resource-grid-container';
            var label = document.createElement('div');
            label.className = 'resource-scale-label';
            label.textContent = '';
            gridContainer.appendChild(label);
            var fill = document.createElement('div');
            fill.className = 'resource-grid-fill';
            gridContainer.appendChild(fill);
            row.appendChild(gridContainer);
            var inner = document.createElement('div');
            inner.className = 'resource-scale-inner';
            for (var i = 0; i < cellCount; i++) {
                var cell = document.createElement('div');
                cell.className = 'resource-scale-cell';
                cell.style.left = (i * widthPct) + '%';
                cell.style.width = widthPct + '%';
                inner.appendChild(cell);
            }
            row.appendChild(inner);

            var wrap = document.createElement('div');
            wrap.className = 'resource-calendar-wrap';
            wrap.appendChild(row);
            return wrap;
        }

        gantt.attachEvent("onAfterTaskUpdate", async function(id, item){
            if(item.$virtual) return;
            await supabaseClient.from('tasks').update({
                text: item.text, 
                start_date: dateToDb(item.start_date), 
                duration: item.duration,
                machine: item.machine, 
                unit: item.unit, 
                major_item: item.major_item,
                owner: item.owner,
                project_number: item.project_number,
                parent: item.parent_name,
                customer_name: item.customer_name,
                project_details: item.project_details
            }).eq('id', id);
        });

        gantt.attachEvent("onAfterTaskAdd", async function(id, item){
            const { data, error } = await supabaseClient.from('tasks').insert([{
                text: item.text,
                start_date: dateToDb(item.start_date),
                duration: item.duration,
                project_number: item.project_number || "",
                machine: item.machine || "",
                unit: item.unit || "",
                major_item: item.major_item || "",
                owner: item.owner || "",
                sort_order: gantt.getTaskIndex(id),
                parent: item.parent_name || "",
                customer_name: item.customer_name || "",
                project_details: item.project_details || ""
            }]).select();
            if (error) {
                alert("登録エラー: " + error.message);
                gantt.deleteTask(id);
            } else {
                gantt.changeTaskId(id, data[0].id);
                fetchTasks();
            }
        });

        gantt.attachEvent("onBeforeTaskDelete", async function(id, item){
            const { error } = await supabaseClient.from('tasks').delete().eq('id', id);
            if(error) {
                alert("削除エラー: " + error.message);
                return false;
            }
            return true;
        });

        gantt.attachEvent("onRowDragEnd", async function(id, target) {
            const task = gantt.getTask(id);
            const siblings = gantt.getChildren(task.parent);
            const updates = siblings.map((sId, index) => {
                if (sId.toString().startsWith("p_")) return null;
                return supabaseClient.from('tasks').update({ sort_order: index }).eq('id', sId);
            }).filter(p => p !== null);
            if (updates.length > 0) {
                await Promise.all(updates);
            }
        });

        async function addProjectFromTemplate() {
            const pNumber = document.getElementById('project_number').value;
            const orderDateStr = document.getElementById('order_date').value;
            const shippingDateStr = document.getElementById('shipping_date').value;
            if (!pNumber || !orderDateStr || !shippingDateStr) return alert("工事番号、受注日、出荷日をすべて入力してください");
            const { data: templates, error: tError } = await supabaseClient.from('task_template').select('*');
            if (tError) return alert("テンプレート取得エラー: " + tError.message);
            const orderDate = new Date(orderDateStr);
            const shippingDate = new Date(shippingDateStr);
            const newTasks = [];
            templates.forEach((temp, index) => {
                let taskStart;
                if (temp.parent === "受注") {
                    taskStart = new Date(orderDate);
                } else {
                    taskStart = new Date(shippingDate);
                    taskStart.setDate(taskStart.getDate() + (temp.relative_start_day || 0));
                }
                newTasks.push({
                    project_number: pNumber,
                    text: temp.parent || temp.text,
                    major_item: temp.major_item,
                    start_date: dateToDb(taskStart),
                    duration: temp.duration || 1,
                    parent: temp.parent || temp.text,
                    machine: "", unit: "",
                    sort_order: index
                });
            });
            if (!newTasks.find(t => t.parent === "受注")) {
                newTasks.push({ project_number: pNumber, text: "受注", major_item: "営業", start_date: dateToDb(orderDate), duration: 1, parent: "受注", sort_order: -1 });
            }
            if (!newTasks.find(t => t.parent === "出荷")) {
                newTasks.push({ project_number: pNumber, text: "出荷", major_item: "操業", start_date: dateToDb(shippingDate), duration: 1, parent: "出荷", sort_order: 999 });
            }
            const partsOrder1 = newTasks.find(t => t.parent === "部品手配1");
            const designTask = newTasks.find(t => t.parent === "基本設計＆計画承認");
            if (partsOrder1 && designTask) {
                designTask.start_date = dateToDb(orderDate);
                const p1Start = new Date(partsOrder1.start_date);
                const diffTime = Math.abs(p1Start - orderDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                designTask.duration = diffDays;
            }
            const { error: iError } = await supabaseClient.from('tasks').insert(newTasks);
            if (iError) alert("タスク登録エラー: " + iError.message);
            else {
                alert(`工事番号 ${pNumber} の標準工程（見出し行）を一括作成しました。`);
                document.getElementById('project_number').value = "";
                document.getElementById('order_date').value = "";
                document.getElementById('shipping_date').value = "";
                fetchTasks();
            }
        }
        fetchTasks();
    </script>
</body>
</html>
