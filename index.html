<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工事工程表 Pro - 全期間表示版</title>
    
    <link rel="stylesheet" href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css">
    <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: "メイリオ", sans-serif; }
        .main-container { display: flex; flex-direction: column; height: 100vh; }
        .header-panel { background: #fff; padding: 10px 15px; border-bottom: 1px solid #ccc; display: flex; flex-direction: column; gap: 8px; }
        .input-row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .input-row input { padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
        .btn-add { padding: 6px 15px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .content-area { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 100px; background: #2c3e50; color: #ecf0f1; display: flex; flex-direction: column; border-right: 1px solid #1a252f; }
        .sidebar-title { padding: 10px; font-weight: bold; background: #1a252f; font-size: 13px; }
        .project-list { flex: 1; overflow-y: auto; }
        .project-item { padding: 8px 10px; border-bottom: 1px solid #34495e; cursor: pointer; font-size: 14px; transition: 0.2s; font-weight: bold; }
        .project-item:hover { background: #34495e; }
        .project-item.active { background: #3498db; color: white; border-left: 5px solid #fff; }
        .chart-container { flex: 1; display: flex; flex-direction: column; background: #fff; position: relative; }

        /* ライトボックスの期間選択を年月日の順に並び替え */
        .gantt_section_time { display: flex !important; flex-wrap: wrap; align-items: center; gap: 5px; }
        .gantt_section_time select:nth-of-type(1) { order: 3; } /* 日 */
        .gantt_section_time select:nth-of-type(2) { order: 2; } /* 月 */
        .gantt_section_time select:nth-of-type(3) { order: 1; } /* 年 */
        .gantt_section_time input, .gantt_section_time span { order: 4; }

        #gantt_here { flex: 1; width: 100%; }
        .toolbar { background: #f8f9fa; padding: 5px 15px; border-bottom: 1px solid #ddd; display: flex; gap: 10px; align-items: center; font-size: 12px; }
        .zoom-btn { padding: 3px 10px; cursor: pointer; background: #fff; border: 1px solid #ccc; border-radius: 3px; }
        .zoom-btn.active { background-color: #3498db; color: #fff; border-color: #3498db; }
        
        .weekend { background: #f4f4f4 !important; } /* 土日：元の薄いグレー */
        .today-line { background: #ff5252; width: 2px !important; opacity: 0.8; z-index: 1000; }
        .gantt_group_row { background-color: #f0f7ff !important; font-weight: bold !important; } /* 見出し行：さらに薄いスカイブルー */
        
        /* 業務別カラー設定（中程度のパステル調） */
        .task-blue, .gantt_project.task-blue { background-color: #85C1E9 !important; border-color: #5DADE2 !important; }
        .task-green, .gantt_project.task-green { background-color: #82E0AA !important; border-color: #58D68D !important; }
        .task-yellow, .gantt_project.task-yellow { background-color: #F7DC6F !important; border-color: #F4D03F !important; }
        .task-red, .gantt_project.task-red { background-color: #F1948A !important; border-color: #EC7063 !important; }
        .task-orange, .gantt_project.task-orange { background-color: #F8C471 !important; border-color: #F5B041 !important; }
        .task-purple, .gantt_project.task-purple { background-color: #D7BDE2 !important; border-color: #AF7AC5 !important; }
        
        /* 特殊タスク（マイルストーン）のスタイル - 非常に目立つ濃い色を設定 */
        .milestone-circle .gantt_task_content { display: none; }
        .milestone-circle { background: none !important; border: none !important; }
        .milestone-circle::before {
            content: "●";
            color: #d32f2f; /* 濃い赤 */
            font-size: 26px;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .milestone-diamond .gantt_task_content { display: none; }
        .milestone-diamond { background: none !important; border: none !important; }
        .milestone-diamond::before {
            content: "◆";
            color: #1976D2; /* 濃い青 */
            font-size: 28px;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .milestone-star .gantt_task_content { display: none; }
        .milestone-star { background: none !important; border: none !important; }
        .milestone-star::before {
            content: "★";
            color: #2E7D32; /* 濃い緑 */
            font-size: 30px;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        
        /* バー内の文字色（白文字に統一） */
        .gantt_task_content { color: #fff !important; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }

        .filter-group {
            display: flex;
            gap: 5px;
            align-items: center;
            margin-left: 10px;
            padding-left: 10px;
            border-left: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header-panel">
            <div class="input-row">
                <input type="text" id="project_number" placeholder="工事番号" style="width:100px">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="font-size: 12px; color: #666;">受注日:</span>
                    <input type="date" id="order_date" title="受注日">
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="font-size: 12px; color: #666;">出荷日:</span>
                    <input type="date" id="shipping_date" title="出荷日">
                </div>
                <button class="btn-add" onclick="addProjectFromTemplate()">新規追加</button>
                <span style="margin-left: 15px; font-size: 13px; font-weight: bold; color: #333;">
                    <span style="color: #d32f2f; font-size: 20px;">●</span> 外観検査
                    <span style="margin-left: 10px; color: #1976D2; font-size: 20px;">◆</span> 出荷確認会議
                    <span style="margin-left: 10px; color: #2E7D32; font-size: 22px;">★</span> 工場出荷
                </span>
                <span id="save-status" style="font-size:11px; color:#999; margin-left:10px;"></span>
            </div>
        </div>

        <div class="toolbar">
            <div class="filter-group" style="margin-left: 0; padding-left: 0; border-left: none;">
                <span>大項目フィルタ:</span>
                <button class="zoom-btn major-filter-btn" onclick="filterByMajorItem('営業', this)">営業</button>
                <button class="zoom-btn major-filter-btn" onclick="filterByMajorItem('設計', this)">設計</button>
                <button class="zoom-btn major-filter-btn" onclick="filterByMajorItem('製管', this)">製管</button>
                <button class="zoom-btn major-filter-btn" onclick="filterByMajorItem('組立', this)">組立</button>
                <button class="zoom-btn major-filter-btn" onclick="filterByMajorItem('電装', this)">電装</button>
                <button class="zoom-btn major-filter-btn" onclick="filterByMajorItem('品証', this)">品証</button>
                <button class="zoom-btn major-filter-btn" onclick="filterByMajorItem('操業', this)">操業</button>
            </div>

            <div class="filter-group">
                <span>機械検索:</span>
                <input type="text" id="machine_search" placeholder="機械名を入力..." style="width:100px; padding:3px; border:1px solid #ccc; border-radius:3px; font-size:12px;" oninput="filterByMachine(this.value)">
            </div>

            <div class="filter-group">
                <span>担当検索:</span>
                <input type="text" id="owner_search" placeholder="名前を入力..." style="width:100px; padding:3px; border:1px solid #ccc; border-radius:3px; font-size:12px;" oninput="filterByOwner(this.value)">
            </div>

            <div style="margin-left:auto; display:flex; align-items:center; gap:10px;">
                <span>表示切替:</span>
                <button class="zoom-btn" onclick="setZoom('days')">日単位</button>
                <button class="zoom-btn" onclick="setZoom('weeks')">週単位</button>
                <button class="zoom-btn" onclick="scrollToToday()" style="background-color: #ebf5ff; border-color: #3498db; color: #3498db;">今日へ移動</button>
                <span id="filter_status" style="font-weight:bold; color:#3498db;">全工程を表示中</span>
                <button class="zoom-btn" onclick="resetFilter()">表示リセット</button>
            </div>
        </div>

        <div class="content-area">
            <div class="sidebar">
                <div class="sidebar-title">工事一覧</div>
                <div id="project_list" class="project-list"></div>
            </div>
            <div class="chart-container">
                <div id="gantt_here"></div>
            </div>
        </div>
    </div>

    <script>
        const S_URL = "https://dgekjzkrybrswsxlcbvh.supabase.co";
        const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRnZWtqemtyeWJyc3dzeGxjYnZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4ODQ3MjIsImV4cCI6MjA4NDQ2MDcyMn0.BsEj53lV3p76yE9fMPTaLn7ocKTNzYPTqIAnBafYItU";
        const supabaseClient = supabase.createClient(S_URL, S_KEY);

        let currentFilter = null;
        let currentMajorFilter = null;
        let currentOwnerFilter = "";
        let currentMachineFilter = "";
        const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
        const dateToDb = gantt.date.date_to_str("%Y-%m-%d");
        const dateToDisplay = gantt.date.date_to_str("%Y/%m/%d");

        gantt.plugins({ marker: true, grouplist: true });
        
        // カレンダー表示範囲（2024/11/1〜3年間）を固定
        gantt.config.start_date = new Date(2024, 10, 1);
        gantt.config.end_date = new Date(2027, 10, 1);
        gantt.config.fit_tasks = false; // タスクに合わせて範囲を自動調整しない
        gantt.config.smart_scales = false; // スケールの最適化を無効化（表示消失を防ぐ）
        gantt.config.date_format = "%Y-%m-%d";
        gantt.config.date_grid = "%Y/%m/%d";

        // カレンダーの日付表示を常に固定する（フィルター時などに消えるのを防ぐ）
        gantt.attachEvent("onBeforeGanttRender", function(){
            gantt.config.start_date = new Date(2024, 10, 1);
            gantt.config.end_date = new Date(2027, 10, 1);
        });

        gantt.config.columns = [
            { name: "project_number", label: "工事番号", width: 75, align: "center", template: function(obj) {
                return obj.project_number || ""; 
            }},
            { name: "text", label: "タスク名", width: 160, tree: true, template: function(obj) {
                return obj.text;
            }},
            { name: "machine", label: "機械", width: 60, align: "center", template: function(obj) {
                if (obj.$virtual) return "";
                return obj.machine || "";
            }},
            { name: "unit", label: "ユニット", width: 60, align: "center", template: function(obj) {
                if (obj.$virtual) return "";
                return obj.unit || "";
            }},
            { name: "owner", label: "担当", width: 100, align: "left", template: function(obj) {
                if (obj.$virtual || !obj.owner) return "";
                return obj.owner.replace(/\d+/g, ""); // すべての数字を削除
            }},
            { name: "start_date", label: "開始日", width: 100, align: "center", template: (t) => {
                return dateToDisplay(t.start_date);
            }},
            { name: "end_date", label: "終了日", width: 100, align: "center", template: (t) => {
                return dateToDisplay(gantt.calculateEndDate(t.start_date, t.duration));
            }},
            { name: "add", label: "", width: 44 }
        ];
        gantt.config.grid_width = 699;
        gantt.config.row_height = 30; // 行の高さを少し狭く設定 (デフォルトは約35〜38px)
        gantt.config.open_tree_initially = false; // 最初は閉じておく
        gantt.config.order_branch = true; // ドラッグによる並べ替えを有効化
        gantt.config.order_branch_free = true;

        // 大項目の選択肢リスト
        const parentOptions = [
            { key: "", label: "なし" },
            { key: "受注", label: "受注" },
            { key: "基本設計＆計画承認", label: "基本設計＆計画承認" },
            { key: "部品手配1", label: "部品手配1" },
            { key: "出図＆部品手配2", label: "出図＆部品手配2" },
            { key: "電気設計", label: "電気設計" },
            { key: "盤組立", label: "盤組立" },
            { key: "組立全体", label: "組立全体" },
            { key: "外観検査", label: "外観検査" },
            { key: "タスクリスト作成", label: "タスクリスト作成" },
            { key: "試運転", label: "試運転" },
            { key: "客先立会", label: "客先立会" },
            { key: "出荷確認会議", label: "出荷確認会議" },
            { key: "出荷準備", label: "出荷準備" },
            { key: "出荷", label: "出荷" },
            { key: "現地工事", label: "現地工事" }
        ];

        // 詳細編集画面（ライトボックス）の設定
        gantt.config.lightbox.sections = [
            { name: "description", height: 70, map_to: "text", type: "textarea", focus: true },
            { name: "parent_name", height: 30, map_to: "parent_name", type: "select", options: parentOptions }, // セレクトボックスに変更
            { name: "project_number", height: 30, map_to: "project_number", type: "textarea" },
            { name: "machine", height: 30, map_to: "machine", type: "textarea" },
            { name: "unit", height: 30, map_to: "unit", type: "textarea" },
            { name: "major_item", height: 30, map_to: "major_item", type: "select", options: [
                { key: "", label: "なし" },
                { key: "設計", label: "設計" },
                { key: "製管", label: "製管" },
                { key: "組立", label: "組立" },
                { key: "電装", label: "電装" },
                { key: "品証", label: "品証" },
                { key: "操業", label: "操業" },
                { key: "営業", label: "営業" }
            ]},
            { name: "owner", height: 30, map_to: "owner", type: "textarea" },
            { name: "time", height: 72, type: "duration", map_to: "auto" }
        ];
        gantt.config.lightbox.time_format = "%Y/%m/%d";
        gantt.locale.labels.section_parent_name = "大項目名(見出し)";
        gantt.locale.labels.section_project_number = "工事番号";
        gantt.locale.labels.section_machine = "機械名";
        gantt.locale.labels.section_unit = "ユニット";
        gantt.locale.labels.section_major_item = "色分け(業務)";
        gantt.locale.labels.section_description = "タスク名";
        gantt.locale.labels.section_owner = "担当";
        gantt.locale.labels.section_time = "期間";

        // ＋ボタンの挙動をカスタマイズ（親の情報を引き継ぐ）
        gantt.attachEvent("onTaskCreated", function(task){
            if (task.parent) {
                const parentTask = gantt.getTask(task.parent);
                if (parentTask.$virtual) {
                    task.project_number = parentTask.project_number;
                    task.parent_name = parentTask.text; // きれいな名前を引き継ぐ
                }
            }
            return true;
        });

        gantt.templates.grid_row_class = function(start, end, task){
            if(task.$virtual) return "gantt_group_row";
            return "";
        };

        gantt.templates.task_row_class = function(start, end, task){
            return "";
        };

        // フィルタ設定：工事番号、大項目、担当名、機械名の絞り込み
        gantt.attachEvent("onBeforeTaskDisplay", function(id, task){
            // 見出し行（仮想タスク）の場合の処理
            if (task.$virtual) {
                // 1. 工事番号フィルタが適用されている場合、その工事番号以外の見出しは非表示
                if (currentFilter && !task.id.startsWith(`p_${currentFilter}_`)) {
                    return false;
                }
                // 2. 大項目フィルタが適用されている場合、見出しの major_item が一致しない場合は非表示
                if (currentMajorFilter && task.major_item !== currentMajorFilter) {
                    return false;
                }
                return true;
            }
            
            // 通常タスクのフィルタ
            if (currentFilter && task.project_number !== currentFilter) return false;
            if (currentMajorFilter && task.major_item !== currentMajorFilter) return false;
            if (currentOwnerFilter && (!task.owner || !task.owner.includes(currentOwnerFilter))) return false;
            if (currentMachineFilter && (!task.machine || !task.machine.includes(currentMachineFilter))) return false;
            return true;
        });

        // 今日のマーカー
        gantt.addMarker({ start_date: new Date(), css: "today-line", text: "今日" });

        // 業務別（major_item）および特殊タスク（text）の色分け・マークテンプレート
        gantt.templates.task_class = function(start, end, task) {
            if (task.text === "外観検査") return "milestone-circle";
            if (task.text === "出荷確認会議") return "milestone-diamond";
            if (task.text === "工場出荷") return "milestone-star";

            switch (task.major_item) {
                case '設計': return "task-blue";
                case '製管':
                case '品証': return "task-green";
                case '組立': return "task-yellow";
                case '電装': return "task-purple";
                case '操業': return "task-red";
                case '営業': return "task-orange";
                default: return "";
            }
        };
        
        gantt.templates.timeline_cell_class = (task, date) => (date.getDay() === 0 || date.getDay() === 6) ? "weekend" : "";
        
        const zoomConfig = {
            levels: [
                { name: "days", scale_height: 75, min_column_width: 25, scales: [
                    { unit: "month", step: 1, format: "%Y/%n" },
                    { unit: "day", step: 1, format: "%j" }, 
                    { unit: "day", step: 1, format: (date) => dayNames[date.getDay()] }
                ]},
                { name: "weeks", scale_height: 50, min_column_width: 25, scales: [
                    { unit: "month", step: 1, format: "%Y/%n" },
                    { unit: "week", step: 1, format: (date) => {
                        const dateToStr = gantt.date.date_to_str("%j");
                        return dateToStr(date);
                    }}
                ]}
            ]
        };
        gantt.ext.zoom.init(zoomConfig);
        gantt.init("gantt_here");

        async function fetchTasks() {
            // 並び順（sort_order）で取得
            const { data, error } = await supabaseClient.from('tasks').select('*').order('sort_order', { ascending: true });
            if (error) return;
            
            const rawTasks = data.map(t => ({
                id: t.id, text: t.text, start_date: t.start_date,
                duration: t.duration, owner: t.owner, project_number: (t.project_number || "").toString().trim(),
                machine: t.machine, unit: t.unit, major_item: t.major_item,
                sort_order: t.sort_order,
                parent_name: (t.parent || "").toString().trim() // 空白を除去して保持
            }));

            // 指定された大項目の並び順
            const parentOrder = [
                "受注", "基本設計＆計画承認", "部品手配1", "出図＆部品手配2", 
                "電気設計", "盤組立", "組立全体", "外観検査", "タスクリスト作成", 
                "試運転", "客先立会", "出荷確認会議", "出荷準備", "出荷", "現地工事"
            ];

            const tasksWithHierarchy = [];
            const parentsMap = {};

            // 1. 工事番号を特定のルールでソートして取得
            // 優先度: 2000番台(1) > 3000番台(2) > 4000番台(3) > D番台(4) > その他(5)
            // 3000番台内では、数字のみを先、アルファベット混じり(3C等)を後に配置
            const getPriority = (p) => {
                if (p.startsWith('2')) return 1;
                if (p.startsWith('3')) return 2;
                if (p.startsWith('4')) return 3;
                if (p.startsWith('D')) return 4;
                return 5;
            };
            const isPureNumeric = (s) => /^\d+$/.test(s);

            const projects = [...new Set(rawTasks.map(t => t.project_number))]
                .filter(Boolean)
                .sort((a, b) => {
                    const priA = getPriority(a);
                    const priB = getPriority(b);
                    if (priA !== priB) return priA - priB;
                    
                    // 同じ番台内での処理（例：3000番台）
                    const numA = isPureNumeric(a);
                    const numB = isPureNumeric(b);
                    if (numA && !numB) return -1; // 数字のみを優先
                    if (!numA && numB) return 1;  // アルファベット混じりを後に
                    
                    return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
                });

            projects.forEach(pNum => {
                const projectTasks = rawTasks.filter(t => t.project_number === pNum);
                
                // 2. 指定された順序（parentOrder）に従って見出しとタスクを配置
                parentOrder.forEach(pName => {
                    const tasksInParent = projectTasks.filter(t => t.parent_name === pName);
                    if (tasksInParent.length > 0) {
                        const parentKey = `p_${pNum}_${pName}`;
                        
                        // 見出し行の期間を計算（子タスクの最小開始日と最大終了日）
                        let minStart = null;
                        let maxEnd = null;
                        tasksInParent.forEach(t => {
                            const start = new Date(t.start_date);
                            const end = gantt.calculateEndDate(start, t.duration);
                            if (!minStart || start < minStart) minStart = start;
                            if (!maxEnd || end > maxEnd) maxEnd = end;
                        });

                        if (!parentsMap[parentKey]) {
                            parentsMap[parentKey] = {
                                id: parentKey,
                                text: pName,
                                project_number: pNum,
                                machine: tasksInParent[0].machine,
                                major_item: tasksInParent[0].major_item,
                                start_date: minStart,
                                end_date: maxEnd,
                                open: false,
                                type: "project",
                                $virtual: true
                            };
                            tasksWithHierarchy.push(parentsMap[parentKey]);
                        }
                        tasksInParent.forEach(t => {
                            t.parent = parentKey;
                            tasksWithHierarchy.push(t);
                        });
                    }
                });

                // 3. 指定リストに含まれない大項目（その他）
                const otherTasks = projectTasks.filter(t => t.parent_name && !parentOrder.includes(t.parent_name));
                const otherParentNames = [...new Set(otherTasks.map(t => t.parent_name))];
                otherParentNames.forEach(pName => {
                    const tasksInParent = otherTasks.filter(t => t.parent_name === pName);
                    if (tasksInParent.length > 0) {
                        const parentKey = `p_${pNum}_${pName}`;
                        if (!parentsMap[parentKey]) {
                            parentsMap[parentKey] = {
                                id: parentKey, text: pName, project_number: pNum,
                                machine: tasksInParent[0].machine, major_item: tasksInParent[0].major_item,
                                open: false, type: "project", $virtual: true
                            };
                            tasksWithHierarchy.push(parentsMap[parentKey]);
                        }
                        tasksInParent.forEach(t => {
                            t.parent = parentKey;
                            tasksWithHierarchy.push(t);
                        });
                    }
                });

                // 4. 大項目が未設定のタスク（工事番号の直下）
                const noParentTasks = projectTasks.filter(t => !t.parent_name);
                noParentTasks.forEach(t => {
                    t.parent = 0;
                    tasksWithHierarchy.push(t);
                });
            });

            updateProjectList(rawTasks);
            gantt.clearAll();
            gantt.parse({ data: tasksWithHierarchy });
            
            // カレンダー範囲を強制的に再適用（parseによる自動調整を上書き）
            gantt.config.start_date = new Date(2024, 10, 1);
            gantt.config.end_date = new Date(2027, 10, 1);
            gantt.render();
            
            scrollToToday();
        }

        // 今日へスクロールする関数（少し余裕を持って表示）
        function scrollToToday() {
            const pos = gantt.posFromDate(new Date());
            gantt.scrollTo(pos - 200, null);
        }

        function setZoom(level) { gantt.ext.zoom.setLevel(level); }

        function updateProjectList(tasks) {
            const listEl = document.getElementById('project_list');
            const projects = [...new Set(tasks.map(t => t.project_number))].filter(Boolean).sort();
            listEl.innerHTML = "";
            projects.forEach(p => {
                const item = document.createElement('div');
                item.className = `project-item ${currentFilter === p ? 'active' : ''}`;
                item.innerText = p;
                item.onclick = () => filterByProject(p);
                listEl.appendChild(item);
            });
        }

        function filterByProject(p) {
            // すでに選択されている工事番号を再度押した場合は解除
            if (currentFilter === p) {
                currentFilter = null;
            } else {
                currentFilter = p;
            }
            updateFilterStatus();
            gantt.render();
            // 工事一覧の見た目も更新するために fetchTasks を呼ぶか、現在の生データからリストを再描画
            // ここでは簡易的に現在の表示状態に合わせてリストを更新
            const allTasks = gantt.getDatastore("task").getItems().filter(t => !t.$virtual);
            updateProjectList(allTasks);
        }

        function filterByMajorItem(major, btn) {
            // すでに選択されているボタンを再度押した場合は解除
            if (currentMajorFilter === major) {
                currentMajorFilter = null;
                btn.classList.remove('active');
            } else {
                currentMajorFilter = major;
                // 他のボタンのactiveを解除
                document.querySelectorAll('.major-filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            updateFilterStatus();
            gantt.render();
        }

        function filterByOwner(val) {
            currentOwnerFilter = val;
            updateFilterStatus();
            gantt.render();
        }

        function filterByMachine(val) {
            currentMachineFilter = val;
            updateFilterStatus();
            gantt.render();
        }

        function updateFilterStatus() {
            let status = "";
            let parts = [];
            if (currentFilter) parts.push(`工事 ${currentFilter}`);
            if (currentMajorFilter) parts.push(currentMajorFilter);
            if (currentMachineFilter) parts.push(`機械: ${currentMachineFilter}`);
            if (currentOwnerFilter) parts.push(`担当: ${currentOwnerFilter}`);
            
            if (parts.length > 0) {
                status = parts.join(" / ") + " を表示中";
            } else {
                status = "全工程を表示中";
            }
            document.getElementById('filter_status').innerText = status;
        }

        function resetFilter() {
            currentFilter = null;
            currentMajorFilter = null;
            currentOwnerFilter = "";
            currentMachineFilter = "";
            document.getElementById('owner_search').value = "";
            document.getElementById('machine_search').value = "";
            document.querySelectorAll('.major-filter-btn').forEach(b => b.classList.remove('active'));
            updateFilterStatus();
            
            // データを再読み込みして初期状態（閉じた状態）で描画し直す
            fetchTasks();
        }

        // 自動保存
        gantt.attachEvent("onAfterTaskUpdate", async function(id, item){
            if(item.$virtual) return;
            await supabaseClient.from('tasks').update({
                text: item.text, 
                start_date: dateToDb(item.start_date), 
                duration: item.duration,
                machine: item.machine, 
                unit: item.unit, 
                major_item: item.major_item,
                owner: item.owner,
                project_number: item.project_number,
                parent: item.parent_name // きれいな名前を保存
            }).eq('id', id);
        });

        // 新規タスク作成時の処理（+ボタンなど）
        gantt.attachEvent("onAfterTaskAdd", async function(id, item){
            const { data, error } = await supabaseClient.from('tasks').insert([{
                text: item.text,
                start_date: dateToDb(item.start_date),
                duration: item.duration,
                project_number: item.project_number || "",
                machine: item.machine || "",
                unit: item.unit || "",
                major_item: item.major_item || "",
                owner: item.owner || "",
                sort_order: gantt.getTaskIndex(id),
                parent: item.parent_name || "" // きれいな名前を保存
            }]).select();

            if (error) {
                alert("登録エラー: " + error.message);
                gantt.deleteTask(id);
            } else {
                gantt.changeTaskId(id, data[0].id);
                fetchTasks();
            }
        });

        // 削除イベント
        gantt.attachEvent("onBeforeTaskDelete", async function(id, item){
            const { error } = await supabaseClient.from('tasks').delete().eq('id', id);
            if(error) {
                alert("削除エラー: " + error.message);
                return false;
            }
            return true;
        });

        // ドラッグ＆ドロップ後の並び順保存
        gantt.attachEvent("onRowDragEnd", async function(id, target) {
            const task = gantt.getTask(id);
            // 同じ親（見出し行）を持つ兄弟タスクを取得
            const siblings = gantt.getChildren(task.parent);
            
            const updates = siblings.map((sId, index) => {
                // 仮想タスク（見出し行）はDBにないのでスキップ
                if (sId.toString().startsWith("p_")) return null;
                
                return supabaseClient.from('tasks').update({
                    sort_order: index
                }).eq('id', sId);
            }).filter(p => p !== null);

            if (updates.length > 0) {
                await Promise.all(updates);
                console.log("並び順をDBに保存しました");
            }
        });

        async function addProjectFromTemplate() {
            const pNumber = document.getElementById('project_number').value;
            const orderDateStr = document.getElementById('order_date').value;
            const shippingDateStr = document.getElementById('shipping_date').value;

            if (!pNumber || !orderDateStr || !shippingDateStr) {
                return alert("工事番号、受注日、出荷日をすべて入力してください");
            }

            // 1. テンプレートから全てのデータを取得（見出し行の元データとして使用）
            const { data: templates, error: tError } = await supabaseClient
                .from('task_template')
                .select('*');

            if (tError) {
                console.error("Supabase Query Error:", tError);
                return alert("テンプレート取得エラー: " + tError.message);
            }

            const orderDate = new Date(orderDateStr);
            const shippingDate = new Date(shippingDateStr);

            // 2. 見出し行（親タスク）のみを作成
            const newTasks = [];

            // テンプレートの各項目を「見出し行」として作成
            // parent列にある項目を元に、逆算で期間を計算
            templates.forEach((temp, index) => {
                let taskStart;
                if (temp.parent === "受注") {
                    // 受注の見出しは入力した受注日を最優先に使用
                    taskStart = new Date(orderDate);
                } else {
                    // それ以外は出荷日から relative_start_day 分戻る（逆算）
                    taskStart = new Date(shippingDate);
                    taskStart.setDate(taskStart.getDate() + (temp.relative_start_day || 0));
                }
                
                newTasks.push({
                    project_number: pNumber,
                    text: temp.parent || temp.text, // バーの中に表示するテキスト（parentを優先）
                    major_item: temp.major_item,
                    start_date: dateToDb(taskStart),
                    duration: temp.duration || 1,
                    parent: temp.parent || temp.text, // 階層化のキー
                    machine: "", // 見出し行なので空
                    unit: "",     // 見出し行なので空
                    sort_order: index // 初期並び順を設定
                });
            });

            // 「受注」と「出荷」がテンプレートにない場合のための補完
            if (!newTasks.find(t => t.parent === "受注")) {
                newTasks.push({
                    project_number: pNumber, text: "受注", major_item: "営業",
                    start_date: dateToDb(orderDate), duration: 1, parent: "受注",
                    sort_order: -1 // 受注は常に先頭
                });
            }
            if (!newTasks.find(t => t.parent === "出荷")) {
                newTasks.push({
                    project_number: pNumber, text: "出荷", major_item: "操業",
                    start_date: dateToDb(shippingDate), duration: 1, parent: "出荷",
                    sort_order: 999 // 出荷は常に最後の方
                });
            }

            // 「基本設計＆計画承認」の期間調整（受注〜部品手配1の間を埋める）
            const partsOrder1 = newTasks.find(t => t.parent === "部品手配1");
            const designTask = newTasks.find(t => t.parent === "基本設計＆計画承認");
            if (partsOrder1 && designTask) {
                designTask.start_date = dateToDb(orderDate);
                const p1Start = new Date(partsOrder1.start_date);
                const diffTime = Math.abs(p1Start - orderDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                designTask.duration = diffDays;
            }

            // Supabaseへ一括登録
            const { error: iError } = await supabaseClient.from('tasks').insert(newTasks);
            
            if (iError) {
                alert("タスク登録エラー: " + iError.message);
            } else {
                alert(`工事番号 ${pNumber} の標準工程（見出し行）を一括作成しました。`);
                document.getElementById('project_number').value = "";
                document.getElementById('order_date').value = "";
                document.getElementById('shipping_date').value = "";
                fetchTasks();
            }
        }

        fetchTasks();
    </script>
</body>
</html>