<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工事工程表 Pro - 全期間表示版</title>
    
    <link rel="stylesheet" href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css">
    <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: "メイリオ", sans-serif; font-size: 13px; }
        .main-container { display: flex; flex-direction: column; height: 100vh; }
        .header-panel { background: #fff; padding: 5px 10px; border-bottom: 1px solid #ccc; display: flex; flex-direction: column; gap: 4px; }
        .input-row { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
        .input-row input { padding: 4px 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; }
        .btn-add { padding: 4px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .content-area { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 100px; background: #2c3e50; color: #ecf0f1; display: flex; flex-direction: column; border-right: 1px solid #1a252f; }
        .sidebar-title { padding: 8px; font-weight: bold; background: #1a252f; font-size: 12px; cursor: pointer; transition: 0.2s; }
        .sidebar-title:hover { background: #34495e; }
        .project-list { flex: 1; overflow-y: auto; }
        .project-item { padding: 6px 8px; border-bottom: 1px solid #34495e; cursor: pointer; font-size: 12px; transition: 0.2s; font-weight: bold; }
        .project-item:hover { background: #34495e; }
        .project-item.active { background: #3498db; color: white; border-left: 5px solid #fff; }
        .chart-container { flex: 1; display: flex; flex-direction: column; background: #fff; position: relative; overflow: hidden; }

        /* ライトボックスの期間選択を年月日の順に並び替え */
        .gantt_section_time { display: flex !important; flex-wrap: wrap; align-items: center; gap: 5px; font-size: 12px; }
        .gantt_section_time select { padding: 2px; font-size: 12px; }
        .gantt_section_time select:nth-of-type(1) { order: 3; } /* 日 */
        .gantt_section_time select:nth-of-type(2) { order: 2; } /* 月 */
        .gantt_section_time select:nth-of-type(3) { order: 1; } /* 年 */
        .gantt_section_time input, .gantt_section_time span { order: 4; }

        .gantt-layout-container { display: flex; flex-direction: column; flex: 1; min-height: 0; width: 100%; }
        #gantt_here { flex: 1; min-height: 0; width: 100%; }
        .resource-header-bar { background: #f8f9fa; padding: 4px 12px; font-weight: bold; font-size: 11px; color: #2c3e50; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; border-top: 1px solid #ddd; }
        /* リソース行の直上に配置したときの固定表示（伸縮しない） */
        .resource-header-bar-fixed { flex: 0 0 auto !important; flex-shrink: 0 !important; z-index: 10; }
        .gantt_layout_resource_row { min-height: 100px; }
        .gantt_layout_resource_row.gantt_layout_row_hidden { display: none !important; }
        /* 初期・閉じた時：下段とその上のリサイザーを非表示にして上段を100%に */
        .resource-panel-closed .gantt_resource_resizer_row,
        .resource-panel-closed .gantt_layout_resource_row { display: none !important; height: 0 !important; min-height: 0 !important; overflow: hidden !important; }
        /* リソース行：1行内で複数タスクをオーバーラップ表示 */
        .resource-cell-overlap { position: relative; }
        .resource-cell-bars { position: relative; width: 100%; height: 100%; min-height: 16px; }
        .resource-cell-bar { position: absolute; top: 1px; height: 12px; min-width: 4px; border-radius: 2px; opacity: 0.85; }
        /* 下段リソース：左グリッド・右タイムラインのヘッダー（タイトル行）を完全非表示し、1行目からデータが同じ高さで始まるようにする */
        .gantt_layout_resource_row .gantt_grid_scale,
        .gantt_layout_resource_row .gantt_grid_head,
        .gantt_layout_resource_row .gantt_grid_head_row,
        .gantt_layout_resource_row .gantt_scale,
        .gantt_layout_resource_row .gantt_scale_line { display: none !important; height: 0 !important; min-height: 0 !important; overflow: hidden !important; }
        .toolbar { background: #f8f9fa; padding: 4px 12px; border-bottom: 1px solid #ddd; display: flex; gap: 8px; align-items: center; font-size: 11px; }
        .zoom-btn { padding: 2px 8px; cursor: pointer; background: #fff; border: 1px solid #ccc; border-radius: 3px; font-size: 12px; }
        .zoom-btn.active { background-color: #3498db; color: #fff; border-color: #3498db; }
        
        .weekend { background: #f4f4f4 !important; } /* 土日：元の薄いグレー */
        .today-line { background: #ff5252; width: 2px !important; opacity: 0.8; z-index: 1000; }
        .gantt_group_row { background-color: #f0f7ff !important; font-weight: bold !important; } /* 見出し行：さらに薄いスカイブルー */
        
        /* カレンダーの年月を中央揃えにする */
        .gantt_scale_cell { text-align: center !important; font-size: 12px; }
        
        /* 業務別カラー設定（中程度のパステル調） */
        .task-blue, .gantt_project.task-blue { background-color: #85C1E9 !important; border-color: #5DADE2 !important; }
        .task-green, .gantt_project.task-green { background-color: #82E0AA !important; border-color: #58D68D !important; }
        .task-yellow, .gantt_project.task-yellow { background-color: #F7DC6F !important; border-color: #F4D03F !important; }
        .task-red, .gantt_project.task-red { background-color: #F1948A !important; border-color: #EC7063 !important; }
        .task-orange, .gantt_project.task-orange { background-color: #F8C471 !important; border-color: #F5B041 !important; }
        .task-purple, .gantt_project.task-purple { background-color: #D7BDE2 !important; border-color: #AF7AC5 !important; }
        
        /* 特殊タスク（マイルストーン）のスタイル - 非常に目立つ濃い色を設定 */
        .milestone-circle .gantt_task_content { display: none; }
        .milestone-circle { background: none !important; border: none !important; }
        .milestone-circle::before {
            content: "●";
            color: #d32f2f; /* 濃い赤 */
            font-size: 22px;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .milestone-diamond .gantt_task_content { display: none; }
        .milestone-diamond { background: none !important; border: none !important; }
        .milestone-diamond::before {
            content: "◆";
            color: #1976D2; /* 濃い青 */
            font-size: 24px;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .milestone-star .gantt_task_content { display: none; }
        .milestone-star { background: none !important; border: none !important; }
        .milestone-star::before {
            content: "★";
            color: #2E7D32; /* 濃い緑 */
            font-size: 26px;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        
        /* バー内の文字色（少し薄いグレーに影付きに統一） */
        .gantt_task_content { 
            color: #555 !important; 
            font-weight: bold; 
            font-size: 11px;
            text-shadow: 0.5px 0.5px 1px rgba(255,255,255,0.8) !important; 
        }

        /* 2000番台以外の見出し行の文字色（白に戻す） */
        .header-non-2000s .gantt_task_content {
            color: #fff !important;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3) !important;
        }

        /* 2000番台の見出し行の文字色（白にする） */
        .header-2000s .gantt_task_content {
            color: #fff !important;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3) !important;
        }
        
        /* 2000番台のバー内の文字色（共通設定を使用するため削除または維持） */
        .task-2000s .gantt_task_content { 
            color: #555 !important; 
            text-shadow: 0.5px 0.5px 1px rgba(255,255,255,0.8) !important; 
        }

        /* 2000番台の見出し行（header-2000s）の場合は白文字を優先 */
        .task-2000s.header-2000s .gantt_task_content {
            color: #fff !important;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3) !important;
        }

        /* 開始日リサイズハンドル（バー左の三角）を表示・有効化（終了日同様に変更可能にする） */
        .gantt_task_drag[data-bind-property="start_date"] {
            display: block !important;
            visibility: visible !important;
            pointer-events: auto !important;
        }

        .filter-group {
            display: flex;
            gap: 4px;
            align-items: center;
            margin-left: 8px;
            padding-left: 8px;
            border-left: 1px solid #ccc;
        }

        /* カスタムツールチップのスタイル */
        .custom-tooltip {
            position: fixed;
            display: none;
            background: rgba(33, 33, 33, 0.75); /* 透明度をアップ (0.95 -> 0.75) */
            backdrop-filter: blur(4px); /* 背景を少しぼかして文字を読みやすく */
            -webkit-backdrop-filter: blur(4px);
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            z-index: 10000;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            white-space: pre-line;
            line-height: 1.4;
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* リソース（下段）＝全体工程表と同じデザイン・土日・今日線を一直線に */
        .resource-header {
            background: #f8f9fa;
            padding: 4px 12px;
            font-weight: bold;
            font-size: 11px;
            color: #2c3e50;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
        }
        .resource-header-close {
            margin-left: 6px;
            padding: 1px 6px;
            border: 1px solid #ccc;
            background: #fff;
            color: #666;
            font-size: 14px;
            line-height: 1;
            cursor: pointer;
            border-radius: 3px;
        }
        .resource-header-close:hover { background: #f0f0f0; color: #333; }
        .resource-content {
            flex: 1;
            overflow: auto;
            padding: 0;
            min-height: 0;
            background: #fff;
        }
        .resource-content-inner {
            display: flex;
            flex-direction: column;
            gap: 0;
            min-width: 1px;
            padding: 0 0 8px 0;
        }
        .resource-item {
            display: flex;
            margin-bottom: 0;
            align-items: center;
            font-size: 11px;
            min-width: min-content;
            min-height: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        .resource-item:last-child { border-bottom: none; }
        .resource-item.clickable:hover { background-color: #ebf5ff !important; }
        .resource-item.clickable:hover .resource-grid-container { background-color: #ebf5ff !important; }
        .resource-item.clickable:hover .resource-timeline { background-color: #ebf5ff !important; }
        /* 下段グリッド：上段と同じ列幅（GRID_WIDTH=699）でカレンダー開始位置を一致・横スクロール時も固定 */
        .resource-grid-container {
            width: 699px;
            min-width: 699px;
            flex-shrink: 0;
            position: sticky;
            left: 0;
            z-index: 2;
            display: flex;
            background: #f5f5f5;
        }
        .resource-item .resource-grid-container { background: #fff; }
        .resource-grid {
            width: 699px;
            min-width: 699px;
            display: flex;
            flex-shrink: 0;
            background: inherit;
            border-right: 1px solid #e0e0e0;
        }
        .resource-grid .resource-cell {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            padding: 0 4px;
            font-size: 11px;
            border-right: 1px solid #e0e0e0;
            box-sizing: border-box;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .resource-grid .resource-cell:last-child { border-right: none; }
        .resource-scale-row .resource-grid { background: #f5f5f5; }
        .resource-item .resource-grid { background: #fff; }
        .resource-cell-w75 { width: 75px; min-width: 75px; justify-content: center; }
        .resource-cell-w160 { width: 160px; min-width: 160px; }
        .resource-cell-w60 { width: 60px; min-width: 60px; justify-content: center; }
        .resource-cell-w100 { width: 100px; min-width: 100px; }
        .resource-cell-w44 { width: 44px; min-width: 44px; }
        .resource-grid-fill {
            width: 624px;
            min-width: 624px;
            flex-shrink: 0;
            background: #f5f5f5;
            border-right: 1px solid #e0e0e0;
        }
        .resource-scale-label {
            width: 75px;
            min-width: 75px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            padding: 0 4px;
            color: #333;
            font-weight: bold;
            font-size: 11px;
            position: sticky;
            left: 0;
            z-index: 2;
            background: #f5f5f5;
            border-right: 1px solid #e0e0e0;
            box-sizing: border-box;
        }
        .resource-timeline {
            flex: 1;
            min-width: 0;
            position: relative;
            z-index: 0;
            height: 20px;
            background: #fff;
            border-right: 1px solid #e0e0e0;
            /* 右スクロール時、グリッド範囲に入ったバーを完全に非表示にする */
            clip-path: inset(0 0 0 var(--resource-clip-left, 0px));
        }
        .resource-timeline-grid {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 0;
        }
        .resource-timeline-grid-cell {
            position: absolute;
            top: 0;
            bottom: 0;
            border-right: 1px solid #e0e0e0;
            box-sizing: border-box;
        }
        .resource-timeline-grid-cell:last-child { border-right: none; }
        .resource-bar {
            position: absolute;
            z-index: 1;
            height: 100%;
            border-radius: 2px;
            border: 1px solid rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555 !important;
            font-size: 10px;
            font-weight: bold;
            text-shadow: 0.5px 0.5px 1px rgba(255,255,255,0.8) !important;
            box-sizing: border-box;
        }
        /* 上段ガントと同じ色・枠（リソースバー用） */
        .resource-bar.task-blue { background-color: #85C1E9 !important; border-color: #5DADE2 !important; }
        .resource-bar.task-green { background-color: #82E0AA !important; border-color: #58D68D !important; }
        .resource-bar.task-yellow { background-color: #F7DC6F !important; border-color: #F4D03F !important; }
        .resource-bar.task-red { background-color: #F1948A !important; border-color: #EC7063 !important; }
        .resource-bar.task-orange { background-color: #F8C471 !important; border-color: #F5B041 !important; }
        .resource-bar.task-purple { background-color: #D7BDE2 !important; border-color: #AF7AC5 !important; }
        /* マイルストーン：上段と同じ記号のみ表示 */
        .resource-bar.milestone-circle { background: none !important; border: none !important; }
        .resource-bar.milestone-circle .resource-bar-text { display: none; }
        .resource-bar.milestone-circle::before { content: "●"; color: #d32f2f; font-size: 18px; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .resource-bar.milestone-diamond { background: none !important; border: none !important; }
        .resource-bar.milestone-diamond .resource-bar-text { display: none; }
        .resource-bar.milestone-diamond::before { content: "◆"; color: #1976D2; font-size: 20px; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .resource-bar.milestone-star { background: none !important; border: none !important; }
        .resource-bar.milestone-star .resource-bar-text { display: none; }
        .resource-bar.milestone-star::before { content: "★"; color: #2E7D32; font-size: 22px; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .resource-scale-row { display: flex; align-items: stretch; margin-bottom: 0; font-size: 11px; }
        .resource-scale-row:first-of-type .resource-scale-inner { border-bottom: 1px solid #e0e0e0; }
        .resource-scale-row:last-of-type .resource-scale-inner { height: 20px; }
        .resource-grid-lines-only .resource-scale-inner { height: 8px; min-height: 8px; }
        .resource-grid-lines-only .resource-scale-cell { border-right: 1px solid #e0e0e0; }
        .resource-scale-inner {
            flex: 1;
            min-width: 0;
            position: relative;
            height: 20px;
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-top: none;
            box-sizing: border-box;
        }
        .resource-scale-row:first-of-type .resource-scale-inner { border-top: 1px solid #e0e0e0; }
        .resource-scale-cell {
            position: absolute;
            top: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid #e0e0e0;
            box-sizing: border-box;
            color: #333;
            font-size: 11px;
            text-align: center;
        }
        .resource-scale-cell:last-child { border-right: none; }
        .resource-scale-cell.weekend { background: #f4f4f4 !important; }
        .resource-calendar-wrap { margin-bottom: 4px; }
        .resource-today-line { position: absolute; top: 0; bottom: 0; width: 2px; background: #ff5252; opacity: 0.8; z-index: 10; pointer-events: none; }
        .resource-today-wrap { position: relative; }
        .resource-today-row .resource-scale-inner { background: transparent; border: none; }
        .resource-placeholder { padding: 20px; color: #999; text-align: center; font-size: 12px; }
        .filter-btn { padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; background: #fff; font-size: 12px; }
        .filter-btn.active { background: #ff9800; color: white; border-color: #e68a00; }
        
        /* 担当未定行の背景を薄い赤にする */
        .unassigned-row {
            background-color: #fff5f5 !important;
        }
        /* 警告マークの見た目調整 */
        .unassigned-warning {
            color: #d32f2f;
            font-weight: bold;
            display: flex;
            justify-content: center;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header-panel">
            <div class="input-row">
                <input type="text" id="project_number" placeholder="工事番号" style="width:100px">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="font-size: 12px; color: #666;">受注日:</span>
                    <input type="date" id="order_date" title="受注日">
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="font-size: 12px; color: #666;">出荷日:</span>
                    <input type="date" id="shipping_date" title="出荷日">
                </div>
                <button class="btn-add" onclick="addProjectFromTemplate()">新規追加</button>
                <span style="margin-left: 15px; font-size: 13px; font-weight: bold; color: #333;">
                    <span style="color: #d32f2f; font-size: 20px;">●</span> 外観検査
                    <span style="margin-left: 10px; color: #1976D2; font-size: 20px;">◆</span> 出荷確認会議
                    <span style="margin-left: 10px; color: #2E7D32; font-size: 22px;">★</span> 工場出荷
                </span>
                <span id="save-status" style="font-size:11px; color:#999; margin-left:10px;"></span>
            </div>
            <div class="input-row" style="border-top: 1px solid #eee; padding-top: 8px;">
                <span style="font-size: 12px; color: #666; margin-right: 5px;">表示順：</span>
                <button id="sort_process_btn" class="zoom-btn active" onclick="setDisplayMode('process')">工程別</button>
                <button id="sort_machine_btn" class="zoom-btn" onclick="setDisplayMode('machine')">機械別</button>
                
                <div style="margin-left:auto; display:flex; align-items:center; gap:10px; font-size: 13px;">
                    <span>表示切替:</span>
                    <button class="zoom-btn" style="font-size: 13px;" onclick="setZoom('days')">日単位</button>
                    <button class="zoom-btn" style="font-size: 13px;" onclick="setZoom('weeks')">週単位</button>
                    <button class="zoom-btn" onclick="scrollToToday()" style="background-color: #ebf5ff; border-color: #3498db; color: #3498db; font-size: 13px;">今日へ移動</button>
                    <span id="filter_status" style="font-weight:bold; color:#3498db; font-size: 13px;">全工程を表示中</span>
                    <button class="zoom-btn" style="font-size: 13px;" onclick="resetFilter()">表示リセット</button>
                </div>
            </div>
        </div>

        <div class="toolbar">
            <div class="filter-group" style="margin-left: 0; padding-left: 0; border-left: none;">
                <span>大項目フィルタ:</span>
                <button class="zoom-btn major-filter-btn" onclick="filterByMajorItem('営業', this)">営業</button>
                <button class="zoom-btn major-filter-btn" onclick="filterByMajorItem('設計', this)">設計</button>
                <button class="zoom-btn major-filter-btn" onclick="filterByMajorItem('製管', this)">製管</button>
                <button class="zoom-btn major-filter-btn" onclick="filterByMajorItem('組立', this)">組立</button>
                <button class="zoom-btn major-filter-btn" onclick="filterByMajorItem('電装', this)">電装</button>
                <button class="zoom-btn major-filter-btn" onclick="filterByMajorItem('品証', this)">品証</button>
                <button class="zoom-btn major-filter-btn" onclick="filterByMajorItem('操業', this)">操業</button>
            </div>

            <div class="filter-group">
                <span>機械検索:</span>
                <input type="text" id="machine_search" placeholder="機械名を入力..." style="width:100px; padding:3px; border:1px solid #ccc; border-radius:3px; font-size:12px;" oninput="filterByMachine(this.value)">
            </div>

            <div class="filter-group">
                <span>担当検索:</span>
                <input type="text" id="owner_search" placeholder="名前を入力..." style="width:100px; padding:3px; border:1px solid #ccc; border-radius:3px; font-size:12px;" oninput="filterByOwner(this.value)">
                <button id="unassigned_filter_btn" class="filter-btn" onclick="toggleUnassignedFilter()" style="margin-left: 5px;">⚠️ 未定のみ</button>
            </div>

            <div class="filter-group">
                <span>リソース（担当者）:</span>
                <input type="text" id="resource_owner_input" placeholder="担当名を入力..." style="width:120px; padding:3px; border:1px solid #ccc; border-radius:3px; font-size:12px;" oninput="showResourceViewByOwner(this.value)">
                <button class="zoom-btn resource-dept-btn" onclick="filterByDepartment('営業', this)">営業</button>
                <button class="zoom-btn resource-dept-btn" onclick="filterByDepartment('設計', this)">設計</button>
                <button class="zoom-btn resource-dept-btn" onclick="filterByDepartment('製管', this)">製管</button>
                <button class="zoom-btn resource-dept-btn" onclick="filterByDepartment('組立', this)">組立</button>
                <button class="zoom-btn resource-dept-btn" onclick="filterByDepartment('電装', this)">電装</button>
                <button class="zoom-btn resource-dept-btn" onclick="filterByDepartment('品証', this)">品証</button>
                <button class="zoom-btn resource-dept-btn" onclick="filterByDepartment('操業', this)">操業</button>
                <button class="zoom-btn resource-location-btn" id="location_resource_btn" onclick="toggleLocationResource(this)" style="background-color: #fdf2f2; border-color: #f1948a; color: #c0392b; font-weight: bold; margin-left: 5px;">組立場所</button>
            </div>
        </div>

        <div class="content-area">
            <div class="sidebar">
                <div class="sidebar-title" onclick="resetFilter()" title="クリックして全表示にリセット">工事一覧</div>
                <div id="project_list" class="project-list"></div>
            </div>
            <div class="chart-container">
                <!-- メインガントチャート -->
                <div id="gantt_here" style="width: 100%; height: 100%;"></div>

                <!-- 独立したリソースパネル -->
                <div id="resource_panel" style="display: none; height: 250px; border-top: 2px solid #ccc; background: #fff; flex-direction: column;">
                    <div id="resource_header_bar" class="resource-header-bar" style="display: none;">
                        <span id="resource_title">リソース状況（担当者で選択）</span>
                        <button type="button" class="resource-header-close" id="resource_close_btn" title="リソース画面を閉じる" aria-label="閉じる">×</button>
                    </div>
                    <div class="resource-content" style="flex: 1; overflow: auto;">
                        <div id="resource_content_inner" class="resource-content-inner">
                            <!-- ここにJSでHTMLが挿入される -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * @typedef {Object} TaskLocation
         * @property {number} id - Primary Key
         * @property {string} task_id - tasks.idへの外部キー
         * @property {string} area_group - E1, E2, E3などのテキスト
         * @property {string} area_number - 0〜7などのテキスト
         */

        const S_URL = "https://dgekjzkrybrswsxlcbvh.supabase.co";
        const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRnZWtqemtyeWJyc3dzeGxjYnZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4ODQ3MjIsImV4cCI6MjA4NDQ2MDcyMn0.BsEj53lV3p76yE9fMPTaLn7ocKTNzYPTqIAnBafYItU";
        const supabaseClient = supabase.createClient(S_URL, S_KEY);

        let currentFilter = null;
        let currentMajorFilter = null;
        let currentDisplayMode = 'process'; // 'process' or 'machine'
        let currentResourceMode = 'individual'; // 'individual' か 'dept'
        let lastDeptName = ''; 
        let lastOwnerName = '';
        let currentOwnerFilter = "";
        let isUnassignedOnly = false; // 担当未定フィルタの状態
        let currentOwnerFilterNoData = false; // tasks と task_template の両方に該当がないとき true
        let currentMachineFilter = "";
        let currentLocationResourceMode = false; // 組立場所リソースモード
        let locationExpandedGroups = { "E1": true, "E2": true, "E3": true }; // 展開状態
        const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
        const dateToDb = gantt.date.date_to_str("%Y-%m-%d");
        const dateToDisplay = gantt.date.date_to_str("%Y/%m/%d");

        // 組立場所の選択肢
        const LOCATION_GROUPS = ["E1", "E2", "E3"];
        const LOCATION_NUMBERS = ["0", "1", "2", "3", "4", "5", "6"];

        // カスタムライトボックスセクション：組立場所
        gantt.form_blocks["location_selector"] = {
            render: function (sns) {
                // コンテナ自体にIDを付与して、後で非表示にしやすくする
                let html = "<div id='location_selector_container' class='location_selector_container' style='padding: 5px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px;'>";
                LOCATION_GROUPS.forEach(group => {
                    html += `<div style='margin-bottom: 8px;'><strong>${group}:</strong><br/>`;
                    LOCATION_NUMBERS.forEach(num => {
                        const val = `${group}-${num}`;
                        html += `<label style='margin-right: 10px; display: inline-block; cursor: pointer;'>
                                    <input type='checkbox' name='task_location' value='${val}' style='vertical-align: middle;'> ${num}
                                 </label>`;
                    });
                    html += "</div>";
                });
                html += "</div>";
                return html;
            },
            set_value: function (node, value, task) {
                // コンテナ要素を取得して常に表示
                const container = node.querySelector('#location_selector_container');
                if (container) {
                    container.style.display = "";
                }

                // 初期化：すべてのチェックボックスを外す
                const checkboxes = node.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = false);

                // タスクに紐付いている場所をチェックする
                // gantt.showLightbox で取得したデータが task.locations に入っている前提
                if (task.locations && Array.isArray(task.locations)) {
                    task.locations.forEach(loc => {
                        const val = `${loc.area_group}-${loc.area_number}`;
                        const cb = node.querySelector(`input[value="${val}"]`);
                        if (cb) cb.checked = true;
                    });
                }
            },
            get_value: function (node, task) {
                // 非表示の場合は空配列を返す
                const container = node.querySelector('#location_selector_container');
                if (container && container.style.display === "none") {
                    return [];
                }

                const checkboxes = node.querySelectorAll('input[type="checkbox"]:checked');
                const selected = [];
                checkboxes.forEach(cb => {
                    const [group, num] = cb.value.split('-');
                    selected.push({ area_group: group, area_number: num });
                });
                return selected;
            },
            focus: function (node) {
            }
        };

        // カスタムライトボックスセクション：担当者複数選択
        gantt.form_blocks["owner_selector"] = {
            render: function (sns) {
                return `<div id='owner_selector_container' class='owner_selector_container' style='padding: 5px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; min-height: 30px; display: flex; flex-wrap: wrap; gap: 10px;'></div>`;
            },
            set_value: function (node, value, task) {
                const majorItem = task.major_item || "";
                const options = getOwnerOptions(majorItem);
                const container = node.querySelector('#owner_selector_container');
                
                let html = "";
                if (options.length === 0) {
                    html = "<span style='color: #999; font-size: 12px;'>フィルタ色分けを選択してください</span>";
                } else {
                    const selectedOwners = (value || "").split(',').map(s => s.trim());
                    options.forEach(opt => {
                        const isChecked = selectedOwners.includes(opt.key) ? "checked" : "";
                        html += `<label style='display: inline-block; cursor: pointer; font-size: 12px;'>
                                    <input type='checkbox' name='owner_checkbox' value='${opt.key}' ${isChecked} style='vertical-align: middle;'> ${opt.label}
                                 </label>`;
                    });
                }
                container.innerHTML = html;
            },
            get_value: function (node, task) {
                const checkboxes = node.querySelectorAll('input[name="owner_checkbox"]:checked');
                const selected = [];
                checkboxes.forEach(cb => selected.push(cb.value));
                return selected.join(', ');
            },
            focus: function (node) {}
        };

        // 上段・下段で完全に一致させる固定値（1ピクセルも狂いなく同期）
        const GRID_WIDTH = 699;
        const COLUMN_WIDTHS = [75, 160, 60, 60, 100, 100, 100, 44]; // 工事番号, タスク名, 機械, ユニット, 担当, 開始日, 終了日, add
        // 下段リソースで担当者検索時にのみフィルタする用（未選択時は下段を非表示）
        let currentResourceOwnerFilter = "";
        window.allTasks = []; // グローバルに全データを保持用

        // 表示期間（上段・下段で同一にし、ズレを防ぐ）
        const GANTT_START_DATE = new Date(2024, 10, 1);  // 2024/11/1
        const GANTT_END_DATE = new Date(2027, 11, 0);   // 2027/11/30（11月末）
        var GANTT_CALENDAR_CONFIG = {
            start_date: new Date(GANTT_START_DATE.getTime()),
            end_date: new Date(GANTT_END_DATE.getTime())
        };

        gantt.plugins({ marker: true, grouplist: true, inline_editors: true });
        
        gantt.config.start_date = GANTT_CALENDAR_CONFIG.start_date;
        gantt.config.end_date = GANTT_CALENDAR_CONFIG.end_date;
        gantt.config.fit_tasks = false; // タスクの有無に関わらず設定期間を維持（下段が10月で終わらないように）
        gantt.config.include_empty_scales = true; // タスクがない期間もカレンダーを表示する
        gantt.config.date_format = "%Y-%m-%d";
        gantt.config.date_grid = "%Y/%m/%d";
        gantt.config.start_on_monday = true; // 週の開始を月曜日に固定

        // 編集画面（ライトボックス）の設定
        const majorItemOptions = [
            { key: "営業", label: "営業" },
            { key: "設計", label: "設計" },
            { key: "製管", label: "製管" },
            { key: "組立", label: "組立" },
            { key: "電装", label: "電装" },
            { key: "品証", label: "品証" },
            { key: "操業", label: "操業" },
            { key: "", label: "指定なし" }
        ];

        // 担当者のマスターデータ
        const ownerMaster = {
            "営業": ["専務", "銭", "麻生", "原田", "岡本", "津村", "前川", "池田"],
            "設計": ["藤山", "田中(善)", "安岡", "川邊", "檀", "堀井", "宮﨑", "津田", "古村", "柴田", "橋本", "松本(英)"],
            "製管": ["製造管理", "資材"],
            "組立": ["米澤", "桂", "香西", "古賀", "長谷川", "早川", "廣田", "宮本", "山下", "センティル", "増田", "千代盛", "外注"],
            "電装": ["木村(至)", "木村(圭)", "守時", "外注"],
            "品証": ["田中(孝)"],
            "操業": ["堀尾", "三浦", "黒見", "大西(元)", "大西(優)", "木本", "前田", "本郷", "大重", "松本(幹)", "秋藤"]
        };

        function getOwnerOptions(majorItem) {
            const list = ownerMaster[majorItem] || [];
            return list.map(name => ({ key: name, label: name }));
        }

        // インラインエディタの設定
        const ownerEditor = {
            type: "select",
            map_to: "owner",
            options: [] // 動的に変更される
        };

        gantt.config.editor_types.owner_editor = {
            show: function (id, column, config, placeholder) {
                const task = gantt.getTask(id);
                const options = getOwnerOptions(task.major_item);
                
                let html = "<select style='width:100%; height:100%; border:none;'>";
                html += "<option value=''>未選択</option>";
                options.forEach(opt => {
                    html += `<option value="${opt.key}" ${task.owner === opt.key ? "selected" : ""}>${opt.label}</option>`;
                });
                html += "</select>";
                placeholder.innerHTML = html;
            },
            hide: function () {
            },
            set_value: function (value, id, column, node) {
                node.firstChild.value = value || "";
            },
            get_value: function (id, column, node) {
                return node.firstChild.value;
            },
            is_changed: function (value, id, column, node) {
                const task = gantt.getTask(id);
                return value !== task.owner;
            },
            is_valid: function (value, id, column, node) {
                return true;
            },
            save: function (id, column, node) {
            },
            focus: function (node) {
                node.firstChild.focus();
            }
        };

        // インラインエディタを有効化
        gantt.config.show_errors = false;

        // 担当者用カスタムコントロールの登録
        gantt.form_blocks["owner_selector"] = {
            render: function(sns) {
                return "<div class='owner_selector_container' style='height:100px; overflow-y:auto; border:1px solid #ccc; padding:5px; background:#fff;'></div>";
            },
            set_value: function(node, value, task) {
                const majorItem = task.major_item || "";
                const owners = ownerMaster[majorItem] || [];
                const selected = (value || "").split(",").map(s => s.trim());

                let html = "";
                if (owners.length === 0) {
                    html = "<span style='color:#999; font-size:12px;'>部署（フィルタ色分け）を選択してください</span>";
                } else {
                    owners.forEach(name => {
                        const isChecked = selected.includes(name) ? "checked" : "";
                        html += `<label style='display:inline-block; width:120px; margin-bottom:3px; font-size:12px; cursor:pointer;'>
                                    <input type='checkbox' value='${name}' ${isChecked} style='vertical-align:middle;'> ${name}
                                 </label>`;
                    });
                }
                node.innerHTML = html;
            },
            get_value: function(node, task) {
                const checked = Array.from(node.querySelectorAll("input:checked")).map(cb => cb.value);
                return checked.join(", ");
            },
            focus: function (node) {}
        };

        gantt.config.lightbox.sections = [
            { name: "project_number", height: 30, map_to: "project_number", type: "textarea", focus: true },
            { name: "parent_name", height: 30, map_to: "parent_name", type: "textarea" },
            { name: "major_item", height: 30, map_to: "major_item", type: "select", options: majorItemOptions },
            { name: "machine", height: 30, map_to: "machine", type: "textarea" },
            { name: "unit", height: 30, map_to: "unit", type: "textarea" },
            { name: "description", height: 50, map_to: "text", type: "textarea" },
            { name: "owner", height: 100, map_to: "owner", type: "owner_selector" },
            { name: "locations", height: 100, map_to: "locations", type: "location_selector" },
            { name: "time", height: 72, type: "duration", map_to: "auto" }
        ];

        // gantt.showLightbox を全タスク共通のシンプルな構造に書き換え
        const originalShowLightbox = gantt.showLightbox;
        gantt.showLightbox = async function(id) {
            try {
                // ① タスクを取得
                const task = gantt.getTask(id);

                // ② 担当者プルダウンの更新（major_itemに連動）
                const majorItem = task.major_item || "";
                const ownerOptions = getOwnerOptions(majorItem);
                const ownerSection = gantt.getLightboxSection("owner");
                if (ownerSection) {
                    ownerSection.control.innerHTML = "";
                    let html = "<option value=''>未選択</option>";
                    ownerOptions.forEach(opt => {
                        html += `<option value="${opt.key}">${opt.label}</option>`;
                    });
                    ownerSection.control.innerHTML = html;
                    ownerSection.setValue(task.owner || "");
                }

                // ③ Supabase から場所データを取得してタスクオブジェクトに保持させる
                // これにより、後続の originalShowLightbox -> set_value でチェックが復元される
                const { data: locations, error } = await supabaseClient
                    .from('task_locations')
                    .select('*')
                    .eq('task_id', id);
                
                if (!error && locations) {
                    task.locations = locations;
                } else {
                    task.locations = [];
                }

                // ④ ライトボックスを表示（内部で set_value が呼ばれる）
                originalShowLightbox.call(gantt, id);

            } catch (e) {
                console.error("Lightbox error:", e);
                // エラー時も最低限表示を試みる
                originalShowLightbox.call(gantt, id);
            }
        };

        gantt.locale.labels.section_locations = "組立場所";

        // major_item が変更された時に担当者リストを更新する
        gantt.attachEvent("onLightboxChange", function(id, name, value) {
            if (name === "major_item") {
                const ownerSection = gantt.getLightboxSection("owner");
                if (ownerSection) {
                    // タスクの major_item を一時的に更新して、set_value が正しいリストを表示できるようにする
                    const task = gantt.getTask(id);
                    task.major_item = value;
                    
                    // set_value を呼び出してチェックボックス一覧を再描画
                    ownerSection.set_value(ownerSection.control, task.owner, task);
                }
            }
        });
        gantt.locale.labels.section_project_number = "工事番号";
        gantt.locale.labels.section_parent_name = "見出し名";
        gantt.locale.labels.section_major_item = "フィルタ色分け";
        gantt.locale.labels.section_machine = "機械";
        gantt.locale.labels.section_unit = "ユニット";
        gantt.locale.labels.section_description = "タスク名";
        gantt.locale.labels.section_owner = "担当";
        gantt.locale.labels.section_time = "期間";

        // 見出し行（プロジェクト型）も同じ項目を表示
        gantt.config.lightbox.project_sections = gantt.config.lightbox.sections;

        // Layout: 上段のみのシンプルな構成
        var layoutRows = [
            {
                cols: [
                    { view: "grid", id: "grid", group: "grids", scrollX: "scrollHor", scrollY: "scrollVer" },
                    { resizer: true, width: 1 },
                    { view: "timeline", id: "timeline", scrollX: "scrollHor", scrollY: "scrollVer" },
                    { view: "scrollbar", scroll: "y", id: "scrollVer" }
                ]
            },
            { view: "scrollbar", scroll: "x", id: "scrollHor", height: 20 }
        ];
        gantt.config.layout = { css: "gantt_container", rows: layoutRows };

        // カレンダー設定の統一（上段・下段で同じ期間）
        gantt.attachEvent("onBeforeGanttRender", function(){
            gantt.config.start_date = new Date(GANTT_START_DATE.getTime());
            gantt.config.end_date = new Date(GANTT_END_DATE.getTime());
            gantt.config.fit_tasks = false;
        });

        // 列設定の共通化：上段・下段に同じ配列を適用し列幅のズレを根絶
        var SHARED_COLUMNS = [
            { name: "project_number", label: "工事番号", width: COLUMN_WIDTHS[0], align: "center", template: function(obj) {
                return obj.project_number || "";
            }},
            { name: "text", label: "タスク名", width: COLUMN_WIDTHS[1], tree: true, template: function(obj) {
                return obj.text;
            }},
            { name: "machine", label: "機械", width: COLUMN_WIDTHS[2], align: "center", template: function(obj) {
                if (obj.$virtual) return "";
                return obj.machine || "";
            }},
            { name: "unit", label: "ユニット", width: COLUMN_WIDTHS[3], align: "center", template: function(obj) {
                if (obj.$virtual) return "";
                return obj.unit || "";
            }},
            { name: "owner", label: "担当", width: COLUMN_WIDTHS[4], align: "left", template: function(obj) {
                if (obj.$virtual) return "";
                if (!obj.owner || obj.owner.trim() === "") {
                    return "<span class='unassigned-warning'>⚠️</span>";
                }
                return obj.owner;
            }},
            { name: "start_date", label: "開始日", width: COLUMN_WIDTHS[5], align: "center", template: function(t) {
                return dateToDisplay(t.start_date);
            }},
            { name: "end_date", label: "終了日", width: COLUMN_WIDTHS[6], align: "center", template: function(t) {
                return dateToDisplay(gantt.calculateEndDate(t.start_date, t.duration));
            }},
            { name: "add", label: "", width: COLUMN_WIDTHS[7] }
        ];
        gantt.config.columns = SHARED_COLUMNS;
        gantt.config.grid_width = GRID_WIDTH;
        gantt.config.grid_resize = false;
        gantt.config.drag_resize = true;
        gantt.config.row_height = 28;
        gantt.config.scale_height = 60;
        gantt.config.min_column_width = 22;
        gantt.config.open_tree_initially = false;
        gantt.config.order_branch = true;
        gantt.config.order_branch_free = true;

        // ドラッグによる並べ替え順序の保存
        gantt.attachEvent("onRowDragEnd", async function(id, target) {
            // --- 現在の展開状態を記憶 ---
            const openTaskIds = new Set();
            gantt.eachTask(function(task) {
                if (task.open) openTaskIds.add(task.id);
            });

            // 全タスクの現在の表示順序を取得して保存
            const tasks = [];
            const count = gantt.getTaskCount();
            for (let i = 0; i < count; i++) {
                const task = gantt.getTaskByIndex(i);
                if (task && !task.$virtual) {
                    const sortData = { id: task.id };
                    if (currentDisplayMode === 'machine') {
                        sortData.sort_order_machine = i;
                    } else {
                        sortData.sort_order = i;
                    }
                    tasks.push(sortData);
                }
            }

            // Supabaseの各タスクの順序を一括更新
            const promises = tasks.map(t => {
                const updatePayload = {};
                if (currentDisplayMode === 'machine') {
                    updatePayload.sort_order_machine = t.sort_order_machine;
                } else {
                    updatePayload.sort_order = t.sort_order;
                }
                return supabaseClient
                    .from('tasks')
                    .update(updatePayload)
                    .eq('id', t.id);
            });

            try {
                await Promise.all(promises);
                console.log("Sort order saved successfully");
                
                // 常に最新のSupabaseデータを反映するため、データを再取得して allTasks と画面を更新
                // fetchTasks側で openTaskIds を使って展開状態を復元するように修正済み
                await fetchTasks();
            } catch (error) {
                console.error("Error saving sort order:", error);
                alert("並び順の保存に失敗しました。");
            }
        });

        // 編集内容をデータベースに保存
        gantt.attachEvent("onAfterTaskUpdate", async function(id, item) {
            if (item.$virtual) return; // 見出し行は仮想的なものなので保存対象外

            const updateData = {
                text: item.text,
                start_date: dateToDb(item.start_date),
                duration: item.duration,
                owner: item.owner,
                project_number: item.project_number,
                machine: item.machine,
                unit: item.unit,
                major_item: item.major_item, // 色分け項目を保存
                parent: item.parent_name // 見出し名をparentカラムに保存
            };

            // 1. タスク本体の更新
            const { error: taskError } = await supabaseClient
                .from('tasks')
                .update(updateData)
                .eq('id', id);

            if (taskError) {
                console.error("Update error:", taskError);
                alert("保存に失敗しました。");
                return;
            }

            // 成功したらデータを再取得して allTasks と画面を更新
            await fetchTasks();
        });

        // 保存ボタンが押された瞬間に実行されるイベント
        // ※ async を付与して Supabase への保存を待機可能にする
        gantt.attachEvent("onLightboxSave", async function(id, item) {
            try {
                // ① ライトボックスから最新のチェック状態を取得
                const locSection = gantt.getLightboxSection("locations");
                let currentLocations = [];
                if (locSection) {
                    currentLocations = locSection.get_value(locSection.control, item);
                    item.locations = currentLocations;
                }

                // ② Supabase への保存処理（組立場所）
                // 既存データを削除
                await supabaseClient
                    .from('task_locations')
                    .delete()
                    .eq('task_id', id);

                // 新規データを登録
                if (currentLocations.length > 0) {
                    const locationRecords = currentLocations.map(loc => ({
                        task_id: id,
                        area_group: loc.area_group,
                        area_number: loc.area_number
                    }));

                    await supabaseClient
                        .from('task_locations')
                        .insert(locationRecords);
                }

                console.log("Locations saved successfully");
                
                // データ保存後にガントチャートを更新して、内部データを最新にする
                gantt.updateTask(id);
                
            } catch (e) {
                console.error("Lightbox save error:", e);
            }
            
            // ③ 最後に必ず true を返してライトボックスを閉じる
            gantt.hideLightbox(); 
            return true;
        });

        // タスクの削除をデータベースに反映
        gantt.attachEvent("onAfterTaskDelete", async function(id, item) {
            if (item.$virtual) return; // 仮想的な見出し行は削除対象外

            const { error } = await supabaseClient
                .from('tasks')
                .delete()
                .eq('id', id);

            if (error) {
                console.error("Delete error:", error);
                alert("削除に失敗しました。");
            } else {
                // 成功したらデータを再取得して allTasks と画面を更新
                await fetchTasks();
            }
        });

        // ＋ボタンの挙動をカスタマイズ（親の情報を引き継ぐ）
        gantt.attachEvent("onTaskCreated", function(task){
            if (task.parent) {
                const parentTask = gantt.getTask(task.parent);
                if (parentTask.$virtual) {
                    task.project_number = parentTask.project_number;
                    task.parent_name = parentTask.text; // きれいな名前を引き継ぐ
                    task.customer_name = parentTask.customer_name;
                    task.project_details = parentTask.project_details;
                }
            }
            return true;
        });

        gantt.templates.grid_row_class = function(start, end, task){
            let css = "";
            if(task.$virtual) {
                css = "gantt_group_row";
            } else if (!task.owner || task.owner.trim() === "") {
                css = "unassigned-row";
            }
            return css;
        };

        // フィルタ設定：工事番号、大項目、担当名、機械名の絞り込み
        gantt.attachEvent("onBeforeTaskDisplay", function(id, task){
            if (task.$virtual) {
                // 工事番号フィルタ
                if (currentFilter && !task.id.startsWith(`p_${currentFilter}_`)) return false;
                
                // 大項目フィルタ、担当名フィルタ、機械検索フィルタ、または 担当未定フィルタ がある場合、子タスクをチェック
                if (currentMajorFilter || currentOwnerFilter || currentMachineFilter || isUnassignedOnly) {
                    var childIds = gantt.getChildren ? gantt.getChildren(task.id) : [];
                    var hasMatchingChild = false;
                    for (var i = 0; i < childIds.length; i++) {
                        var child = gantt.getTask(childIds[i]);
                        if (!child) continue;
                        
                        var matchMajor = !currentMajorFilter || child.major_item === currentMajorFilter;
                        var matchOwner = !currentOwnerFilter || (child.owner && (child.owner + "").includes(currentOwnerFilter));
                        var matchMachine = !currentMachineFilter || (child.machine && (child.machine + "").includes(currentMachineFilter));
                        var matchUnassigned = !isUnassignedOnly || (!child.owner || child.owner.trim() === "");
                        
                        if (matchMajor && matchOwner && matchMachine && matchUnassigned) {
                            hasMatchingChild = true;
                            break;
                        }
                    }
                    if (!hasMatchingChild) return false;
                }
                return true;
            }
            if (currentFilter && task.project_number !== currentFilter) return false;
            if (currentMajorFilter && task.major_item !== currentMajorFilter) return false;
            if (currentOwnerFilter && (!task.owner || !task.owner.includes(currentOwnerFilter))) return false;
            if (currentMachineFilter && (!task.machine || !task.machine.includes(currentMachineFilter))) return false;
            if (isUnassignedOnly && (task.owner && task.owner.trim() !== "")) return false;
            return true;
        });

        // 今日のマーカー
        gantt.addMarker({ start_date: new Date(), css: "today-line", text: "今日" });

        // 業務別カラー
        gantt.templates.task_text = function(start, end, task) {
            const projectNumber = (task.project_number || "").toString();
            const is2000s = projectNumber.startsWith('2');

            if (task.$virtual) {
                // 見出し行
                if (is2000s) {
                    return task.text; // 2000番台は工程名を表示
                } else {
                    return projectNumber; // それ以外は工事番号を表示
                }
            }

            // 子タスク
            if (is2000s) {
                // 2000番台：機械名とユニット名を表示
                const machine = task.machine || "";
                const unit = task.unit || "";
                if (machine && unit) return `${machine} - ${unit}`;
                return machine || unit || task.text;
            } else {
                // それ以外：タスク名を表示
                return task.text;
            }
        };

        gantt.templates.task_class = function(start, end, task) {
            const projectNumber = (task.project_number || "").toString();
            const is2000s = projectNumber.startsWith('2');
            let css = is2000s ? "task-2000s " : "";

            // 2000番台以外の見出し行に特定のクラスを付与
            if (task.$virtual && !is2000s) {
                css += "header-non-2000s ";
            }
            
            // 2000番台の見出し行に特定のクラスを付与
            if (task.$virtual && is2000s && currentDisplayMode === 'machine') {
                css += "header-2000s ";
            }

            if (task.text === "外観検査") return css + "milestone-circle";
            if (task.text === "出荷確認会議") return css + "milestone-diamond";
            if (task.text === "工場出荷") return css + "milestone-star";

            switch (task.major_item) {
                case '設計': css += "task-blue"; break;
                case '製管':
                case '品証': css += "task-green"; break;
                case '組立': css += "task-yellow"; break;
                case '電装': css += "task-purple"; break;
                case '操業': css += "task-red"; break;
                case '営業': css += "task-orange"; break;
                default: break;
            }
            return css;
        };
        
        gantt.templates.timeline_cell_class = (task, date) => (date.getDay() === 0 || date.getDay() === 6) ? "weekend" : "";
        
        const zoomConfig = {
            levels: [
                { name: "days", scale_height: 60, min_column_width: 22, scales: [
                    { unit: "month", step: 1, format: "%Y/%n" },
                    { unit: "day", step: 1, format: "%j" }, 
                    { unit: "day", step: 1, format: (date) => dayNames[date.getDay()] }
                ]},
                { name: "weeks", scale_height: 60, min_column_width: 22, scales: [
                    { unit: "month", step: 1, format: "%Y/%n" },
                    { unit: "week", step: 1, format: (date) => {
                        const dateToStr = gantt.date.date_to_str("%j");
                        return dateToStr(date);
                    }}
                ]}
            ]
        };
        gantt.ext.zoom.init(zoomConfig);
        gantt.init("gantt_here");

        // 入力した担当名 or 部署名で下段のみ絞り込み
        let currentResourceDeptFilter = "";

        function filterByDepartment(deptName, btn) {
            currentResourceMode = 'dept';
            lastDeptName = deptName;

            // 1. 選択状態の管理
            if (currentResourceDeptFilter === deptName && btn) { // btnがある場合のみトグル動作
                currentResourceDeptFilter = "";
                currentResourceMode = 'individual'; // 解除時はデフォルトに戻す
            } else {
                currentResourceDeptFilter = deptName;
            }

            // ボタンのアクティブ状態を更新
            document.querySelectorAll('.resource-dept-btn').forEach(b => {
                b.classList.toggle('active', b === btn && currentResourceDeptFilter !== "");
            });

            const resourcePanel = document.getElementById("resource_panel");
            const ganttHere = document.getElementById("gantt_here");

            if (!currentResourceDeptFilter) {
                // 解除時はパネルを閉じる
                if (resourcePanel) resourcePanel.style.display = "none";
                if (ganttHere) ganttHere.style.height = "100%";
                gantt.render();
                return;
            }

            // 2. window.allTasks から major_item が deptName と一致するタスクを抽出
            const deptTasks = (window.allTasks || []).filter(t => t.major_item === deptName);

            // 3. 抽出したタスクから owner のリスト（重複なし）を生成
            // 「・」「、」「,」で分割して個別の名前として抽出
            const owners = [...new Set(deptTasks.flatMap(t => t.owner ? t.owner.split(/[、・,]/) : []))].filter(Boolean).sort();

            // 4. リソースパネルを表示
            if (resourcePanel) resourcePanel.style.display = "flex";
            if (ganttHere) ganttHere.style.height = "calc(100% - 250px)";

            // 5. renderDepartmentSummary(owners, deptName) を実行
            renderDepartmentSummary(owners, deptName);
            
            gantt.render();
        }

        function renderDepartmentSummary(owners, deptName) {
            const container = document.getElementById("resource_content_inner");
            if (!container) return;
            container.innerHTML = "";

            if (owners.length === 0) {
                container.innerHTML = `<div class="resource-placeholder">【${deptName}】に該当する担当タスクはありません</div>`;
                return;
            }

            // スケール情報の取得
            const scale = gantt.getScale();
            const timelineWidth = scale.full_width;
            const columnWidth = scale.col_width;
            const totalWidth = GRID_WIDTH + timelineWidth;
            
            // 背景の目盛り線の開始位置を計算（週表示などでズレを防ぐ）
            const firstDate = scale.trace_x[0];
            const firstPos = gantt.posFromDate(firstDate);
            const gridBackground = `repeating-linear-gradient(to right, transparent, transparent ${columnWidth - 1}px, #eee ${columnWidth - 1}px, #eee ${columnWidth}px)`;
            // background-position を調整してメイン画面のグリッド線と同期
            const backgroundStyle = `background-image: ${gridBackground}; background-position: ${-firstPos}px 0; background-size: ${columnWidth}px 100%;`;

            let html = "";
            
            // ヘッダー行
            html += `
                <div class="resource-item resource-summary-header" style="display: flex; border-bottom: 1px solid #ddd; min-height: 24px; height: 24px; align-items: center; background: #f8f9fa; position: sticky; top: 0; left: 0; z-index: 10; width: ${totalWidth}px;">
                    <div style="padding: 0 15px; font-weight: bold; color: #2c3e50; font-size: 11px; position: sticky; left: 0; background: inherit; height: 100%; display: flex; align-items: center; z-index: 11; white-space: nowrap;">
                        部署：${deptName}（${owners.length}名）
                    </div>
                    <div style="position: sticky; right: 0; background: inherit; height: 100%; display: flex; align-items: center; padding-right: 10px; margin-left: auto; z-index: 11;">
                        <button type="button" class="resource-header-close" onclick="closeResourcePanel()">×</button>
                    </div>
                </div>
            `;

            // 各担当者ごとの行を生成
            owners.forEach(ownerName => {
                // そのメンバーの名前が task.owner に「含まれている」かどうかで判定
                const ownerTasks = window.allTasks.filter(t => t.owner && t.owner.includes(ownerName));
                
                html += `
                    <div class="resource-item clickable" style="display: flex; border-bottom: 1px solid #eee; min-height: 22px; height: 22px; align-items: stretch; cursor: pointer;" onclick="showResourceViewByOwner('${ownerName.replace(/'/g, "\\'")}')">
                        <div class="resource-grid-container" style="width: ${GRID_WIDTH}px; min-width: ${GRID_WIDTH}px; flex-shrink: 0; display: flex; border-right: 1px solid #ddd; background: #f9f9f9; position: sticky; left: 0; z-index: 1;">
                            <div class="resource-cell" style="width: ${COLUMN_WIDTHS[0]}px; border-right: 1px solid #eee; padding: 0 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold;">担当者</div>
                            <div class="resource-cell" style="width: ${COLUMN_WIDTHS[1]}px; border-right: 1px solid #eee; padding: 0 4px; display: flex; align-items: center; font-size: 10px; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${ownerName.replace(/\d+/g, "")}</div>
                            <div class="resource-cell" style="flex: 1;"></div>
                        </div>
                        <div class="resource-timeline" style="width: ${timelineWidth}px; flex-shrink: 0; position: relative; background: #fff; ${backgroundStyle}">
                            <div class="resource-cell-bars" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
                `;

                // 担当者のタスクをタイムラインに描画
                ownerTasks.forEach(t => {
                    const start = new Date(t.start_date);
                    const end = gantt.calculateEndDate(start, t.duration);
                    const left = gantt.posFromDate(start);
                    const right = gantt.posFromDate(end);
                    const width = Math.max(2, right - left);
                    const colorClass = getResourceTaskClass(t);

                    html += `
                        <div class="resource-cell-bar ${colorClass}" 
                             style="position: absolute; top: 3px; height: 14px; left: ${left}px; width: ${width}px; border-radius: 3px; opacity: 0.8; display: flex; align-items: center; justify-content: center; color: #555; font-size: 9px; font-weight: bold; overflow: hidden; white-space: nowrap; text-shadow: 0.5px 0.5px 1px rgba(255,255,255,0.8);" 
                             title="${t.text} (${t.project_number})">
                             ${t.project_number || ""}
                        </div>
                    `;
                });

                html += `
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            syncResourceScroll();
        }

        function showResourceViewByOwner(ownerValue) {
            currentResourceMode = 'individual';
            const finalOwner = ownerValue || document.getElementById("resource_owner_input")?.value || lastOwnerName;
            lastOwnerName = finalOwner;

            currentResourceDeptFilter = "";
            currentResourceOwnerFilter = (finalOwner || "").trim();
            
            // 入力欄も更新（数字を除去して名前のみ表示）
            const inp = document.getElementById("resource_owner_input");
            if (inp) inp.value = currentResourceOwnerFilter.replace(/\d+/g, "");
            
            // 担当者入力時は部署ボタンのアクティブを解除
            document.querySelectorAll('.resource-dept-btn').forEach(b => b.classList.remove('active'));
            
            updateResourceVisibility();
        }

        function updateResourceVisibility() {
            const resourcePanel = document.getElementById("resource_panel");
            const ganttHere = document.getElementById("gantt_here");
            const hasFilter = currentResourceOwnerFilter || currentResourceDeptFilter || currentLocationResourceMode;

            // スクロール位置を保存
            const scrollState = gantt.getScrollState();

            if (hasFilter) {
                if (resourcePanel) resourcePanel.style.display = "flex";
                if (ganttHere) ganttHere.style.height = "calc(100% - 250px)";
                
                if (currentLocationResourceMode) {
                    renderLocationResourceTimeline();
                } else {
                    renderResourceTimeline();
                }
            } else {
                if (resourcePanel) resourcePanel.style.display = "none";
                if (ganttHere) ganttHere.style.height = "100%";
            }
            
            gantt.render();
            
            // スクロール位置を復元
            gantt.scrollTo(scrollState.x, scrollState.y);
        }

        // リソース画面を閉じる
        function closeResourcePanel() {
            const inp = document.getElementById("resource_owner_input");
            if (inp) inp.value = "";
            currentResourceOwnerFilter = "";
            currentResourceDeptFilter = "";
            currentLocationResourceMode = false;
            document.getElementById('location_resource_btn')?.classList.remove('active');
            updateResourceVisibility();
        }

        // 組立場所リソースのトグル
        async function toggleLocationResource(btn) {
            if (currentLocationResourceMode) {
                closeResourcePanel();
            } else {
                // 他のリソースフィルタをクリア
                currentResourceOwnerFilter = "";
                currentResourceDeptFilter = "";
                document.querySelectorAll('.resource-dept-btn').forEach(b => b.classList.remove('active'));
                const inp = document.getElementById("resource_owner_input");
                if (inp) inp.value = "";

                currentLocationResourceMode = true;
                btn.classList.add('active');
                updateResourceVisibility();
            }
        }

        // 組立場所の展開/折りたたみ
        function toggleLocationGroup(group) {
            locationExpandedGroups[group] = !locationExpandedGroups[group];
            renderLocationResourceTimeline();
        }

        // 組立場所リソースの描画
        async function renderLocationResourceTimeline() {
            const container = document.getElementById("resource_content_inner");
            if (!container) return;

            // task_locations データを取得
            const { data: locData, error } = await supabaseClient
                .from('task_locations')
                .select('task_id, area_group, area_number');
            
            if (error) {
                container.innerHTML = '<div class="resource-placeholder">データの取得に失敗しました</div>';
                return;
            }

            // タスクデータと結合
            const locationTasks = locData.map(ld => {
                const task = window.allTasks.find(t => t.id === ld.task_id);
                return task ? { ...task, area_group: ld.area_group, area_number: ld.area_number } : null;
            }).filter(Boolean);

            const scale = gantt.getScale();
            const timelineWidth = scale.full_width;
            const columnWidth = scale.col_width;
            const totalWidth = GRID_WIDTH + timelineWidth;
            
            // 背景の目盛り線の開始位置を計算（週表示などでズレを防ぐ）
            const firstDate = scale.trace_x[0];
            const firstPos = gantt.posFromDate(firstDate);
            const gridBackground = `repeating-linear-gradient(to right, transparent, transparent ${columnWidth - 1}px, #eee ${columnWidth - 1}px, #eee ${columnWidth}px)`;
            // background-position を調整してメイン画面のグリッド線と同期
            const backgroundStyle = `background-image: ${gridBackground}; background-position: ${-firstPos}px 0; background-size: ${columnWidth}px 100%;`;

            let html = "";
            
            // ヘッダー
            html += `
                <div class="resource-item resource-summary-header" style="display: flex; border-bottom: 1px solid #ddd; min-height: 24px; height: 24px; align-items: center; background: #f8f9fa; position: sticky; top: 0; left: 0; z-index: 10; width: ${totalWidth}px;">
                    <div style="padding: 0 15px; font-weight: bold; color: #2c3e50; font-size: 11px; position: sticky; left: 0; background: inherit; height: 100%; display: flex; align-items: center; z-index: 11; white-space: nowrap;">
                        組立場所別リソース状況
                    </div>
                    <div style="position: sticky; right: 0; background: inherit; height: 100%; display: flex; align-items: center; padding-right: 10px; margin-left: auto; z-index: 11;">
                        <button type="button" class="resource-header-close" onclick="closeResourcePanel()">×</button>
                    </div>
                </div>
            `;

            LOCATION_GROUPS.forEach(group => {
                const isExpanded = locationExpandedGroups[group];
                // グループ行
                html += `
                    <div class="resource-item" style="display: flex; border-bottom: 1px solid #ddd; min-height: 24px; height: 24px; align-items: center; background: #ebf5ff; cursor: pointer; width: ${totalWidth}px;" onclick="toggleLocationGroup('${group}')">
                        <div style="padding: 0 10px; font-weight: bold; color: #3498db; font-size: 11px; position: sticky; left: 0; background: inherit; z-index: 1;">
                            ${isExpanded ? '▼' : '▶'} ${group}
                        </div>
                    </div>
                `;

                if (isExpanded) {
                    LOCATION_NUMBERS.forEach(num => {
                        const areaTasks = locationTasks.filter(t => t.area_group === group && t.area_number === num);
                        
                        html += `
                            <div class="resource-item" style="display: flex; border-bottom: 1px solid #eee; min-height: 22px; height: 22px; align-items: stretch;">
                                <div class="resource-grid-container" style="width: ${GRID_WIDTH}px; min-width: ${GRID_WIDTH}px; flex-shrink: 0; display: flex; border-right: 1px solid #ddd; background: #fff; position: sticky; left: 0; z-index: 1;">
                                    <div class="resource-cell" style="width: 40px; border-right: 1px solid #eee; padding: 0 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: #666;">${num}</div>
                                    <div class="resource-cell" style="flex: 1; font-size: 10px; color: #999; padding-left: 10px; display: flex; align-items: center;">${areaTasks.length > 0 ? areaTasks.length + '件のタスク' : ''}</div>
                                </div>
                                <div class="resource-timeline" style="width: ${timelineWidth}px; flex-shrink: 0; position: relative; background: #fff; ${backgroundStyle}">
                                    <div class="resource-cell-bars" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
                        `;

                        areaTasks.forEach(t => {
                            const start = new Date(t.start_date);
                            const end = gantt.calculateEndDate(start, t.duration);
                            const left = gantt.posFromDate(start);
                            const right = gantt.posFromDate(end);
                            const width = Math.max(2, right - left);
                            const colorClass = getResourceTaskClass(t);

                            html += `
                                <div class="resource-cell-bar ${colorClass}" 
                                     style="position: absolute; top: 3px; height: 14px; left: ${left}px; width: ${width}px; border-radius: 3px; opacity: 0.8; display: flex; align-items: center; justify-content: center; color: #555; font-size: 9px; font-weight: bold; overflow: hidden; white-space: nowrap; text-shadow: 0.5px 0.5px 1px rgba(255,255,255,0.8);" 
                                     title="${t.project_number || ""}-${t.machine || ""}${t.unit || ""}">
                                     ${t.project_number || ""} ${t.machine || ""}
                                </div>
                            `;
                        });

                        html += `
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
            });

            container.innerHTML = html;
            syncResourceScroll();
        }

        // リソース画面の描画処理
        function renderResourceTimeline() {
            const container = document.getElementById("resource_content_inner");
            if (!container) return;

            if (!currentResourceOwnerFilter && !currentResourceDeptFilter) {
                container.innerHTML = '<div class="resource-placeholder">担当者または部署を選択してリソース状況を表示</div>';
                return;
            }

            // window.allTasks からフィルタリング
            const filteredTasks = (window.allTasks || []).filter(t => {
                if (currentResourceDeptFilter) {
                    return t.major_item === currentResourceDeptFilter;
                }
                // 個人詳細画面を表示する際も、完全一致ではなく、その名前が含まれているタスクをすべて抽出
                return t.owner && t.owner.toLowerCase().includes(currentResourceOwnerFilter.toLowerCase());
            });

            if (filteredTasks.length === 0) {
                container.innerHTML = `<div class="resource-placeholder">該当する${currentResourceDeptFilter ? '部署' : '担当者'}のタスクはありません</div>`;
                return;
            }

            // 工事番号の優先度計算
            const getPriority = (p) => {
                if (!p) return 5;
                if (p.startsWith('2')) return 1;
                if (p.startsWith('3')) return 2;
                if (p.startsWith('4')) return 3;
                if (p.startsWith('D')) return 4;
                return 5;
            };

            // 上段の工程表と同じ条件でソート
            filteredTasks.sort((a, b) => {
                const pNumA = a.project_number || "";
                const pNumB = b.project_number || "";
                const priA = getPriority(pNumA);
                const priB = getPriority(pNumB);
                if (priA !== priB) return priA - priB;
                return pNumA.localeCompare(pNumB, undefined, { numeric: true, sensitivity: 'base' });
            });

            const scale = gantt.getScale();
            const timelineWidth = scale.full_width;
            const columnWidth = scale.col_width;
            const totalWidth = GRID_WIDTH + timelineWidth;

            // 背景の目盛り線の開始位置を計算（週表示などでズレを防ぐ）
            const firstDate = scale.trace_x[0];
            const firstPos = gantt.posFromDate(firstDate);
            const gridBackground = `repeating-linear-gradient(to right, transparent, transparent ${columnWidth - 1}px, #eee ${columnWidth - 1}px, #eee ${columnWidth}px)`;
            // background-position を調整してメイン画面のグリッド線と同期
            const backgroundStyle = `background-image: ${gridBackground}; background-position: ${-firstPos}px 0; background-size: ${columnWidth}px 100%;`;

            let html = "";
            
            // 担当者名とタスク件数を表示する固定ヘッダー行
            const filterTitle = currentResourceDeptFilter ? `部署：${currentResourceDeptFilter}` : `担当：${currentResourceOwnerFilter}`;
            html += `
                <div class="resource-item resource-summary-header" style="display: flex; border-bottom: 1px solid #ddd; min-height: 24px; height: 24px; align-items: center; background: #f8f9fa; position: sticky; top: 0; left: 0; z-index: 10; width: ${totalWidth}px;">
                    <div style="padding: 0 15px; font-weight: bold; color: #2c3e50; font-size: 11px; position: sticky; left: 0; background: inherit; height: 100%; display: flex; align-items: center; z-index: 11; white-space: nowrap;">
                        【${filterTitle}】のタスク　${filteredTasks.length}件
                    </div>
                    <div style="position: sticky; right: 0; background: inherit; height: 100%; display: flex; align-items: center; padding-right: 10px; margin-left: auto; z-index: 11;">
                        <button type="button" class="resource-header-close" onclick="closeResourcePanel()">×</button>
                    </div>
                </div>
            `;
            
            filteredTasks.forEach(t => {
                const start = new Date(t.start_date);
                const end = gantt.calculateEndDate(start, t.duration);
                
                const left = gantt.posFromDate(start);
                const right = gantt.posFromDate(end);
                const width = Math.max(2, right - left);
                
                const colorClass = getResourceTaskClass(t);
                const title = `${t.text} (${t.project_number})`;

                // 4. 【グリッド幅の固定】
                html += `
                    <div class="resource-item" style="display: flex; border-bottom: 1px solid #eee; min-height: 22px; height: 22px; align-items: stretch;">
                        <div class="resource-grid-container" style="width: ${GRID_WIDTH}px; min-width: ${GRID_WIDTH}px; flex-shrink: 0; display: flex; border-right: 1px solid #ddd; background: #fff; position: sticky; left: 0; z-index: 1;">
                            <div class="resource-cell" style="width: ${COLUMN_WIDTHS[0]}px; border-right: 1px solid #eee; padding: 0 4px; display: flex; align-items: center; justify-content: center; font-size: 10px;">${t.project_number || ""}</div>
                            <div class="resource-cell" style="width: ${COLUMN_WIDTHS[1]}px; border-right: 1px solid #eee; padding: 0 4px; display: flex; align-items: center; font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${t.text || ""}</div>
                            <div class="resource-cell" style="width: ${COLUMN_WIDTHS[2]}px; border-right: 1px solid #eee; padding: 0 4px; display: flex; align-items: center; justify-content: center; font-size: 10px;">${t.machine || ""}</div>
                            <div class="resource-cell" style="width: ${COLUMN_WIDTHS[3]}px; border-right: 1px solid #eee; padding: 0 4px; display: flex; align-items: center; justify-content: center; font-size: 10px;">${t.unit || ""}</div>
                            <div class="resource-cell" style="width: ${COLUMN_WIDTHS[4]}px; border-right: 1px solid #eee; padding: 0 4px; display: flex; align-items: center; font-size: 10px;">${(t.owner || "").replace(/\d+/g, "")}</div>
                            <div class="resource-cell" style="width: ${COLUMN_WIDTHS[5]}px; border-right: 1px solid #eee; padding: 0 4px; display: flex; align-items: center; justify-content: center; font-size: 10px;">${dateToDisplay(start)}</div>
                            <div class="resource-cell" style="width: ${COLUMN_WIDTHS[6]}px; border-right: 1px solid #eee; padding: 0 4px; display: flex; align-items: center; justify-content: center; font-size: 10px;">${dateToDisplay(end)}</div>
                            <div class="resource-cell" style="width: ${COLUMN_WIDTHS[7]}px; padding: 0 4px;"></div>
                        </div>
                        <div class="resource-timeline" style="width: ${timelineWidth}px; flex-shrink: 0; position: relative; background: #fafafa; ${backgroundStyle}">
                            <div class="resource-cell-bars" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
                                <div class="resource-cell-bar ${colorClass}" 
                                     style="position: absolute; top: 3px; height: 14px; left: ${left}px; width: ${width}px; border-radius: 3px; opacity: 0.8; display: flex; align-items: center; justify-content: center; color: #555; font-size: 9px; font-weight: bold; overflow: hidden; white-space: nowrap; text-shadow: 0.5px 0.5px 1px rgba(255,255,255,0.8);" 
                                     title="${title.replace(/"/g, "&quot;")}">
                                     ${t.project_number || ""}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            syncResourceScroll();
        }

        // 2. 【スクロールの同期】
        gantt.attachEvent("onGanttScroll", function (left, top){
            const resourceContent = document.querySelector(".resource-content");
            if (resourceContent) {
                resourceContent.scrollLeft = left;
            }
        });

        // 3. 【ズーム切り替え時の再描画】
        function setZoom(level) { 
            // スクロール位置を保存
            const scrollState = gantt.getScrollState();

            gantt.ext.zoom.setLevel(level); 
            gantt.config.start_date = new Date(GANTT_START_DATE.getTime());
            gantt.config.end_date = new Date(GANTT_END_DATE.getTime());
            gantt.config.fit_tasks = false;
            gantt.render();
            
            // スクロール位置を復元
            gantt.scrollTo(scrollState.x, scrollState.y);

            if (currentLocationResourceMode) {
                renderLocationResourceTimeline();
            } else if (currentResourceMode === 'dept' && lastDeptName) {
                filterByDepartment(lastDeptName);
            } else {
                const owner = document.getElementById("resource_owner_input")?.value || lastOwnerName;
                if (owner) showResourceViewByOwner(owner);
            }
        }

        function syncResourceScroll() {
            const ganttScroll = gantt.getScrollState();
            const resourceContent = document.querySelector(".resource-content");
            if (resourceContent) resourceContent.scrollLeft = ganttScroll.x;
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const resourceContent = document.querySelector(".resource-content");
                if (resourceContent) {
                    resourceContent.addEventListener('scroll', function() {
                        gantt.scrollTo(this.scrollLeft, null);
                    });
                }
            }, 1000);
        });

        function getResourceTaskClass(task) {
            if (task.text === "外観検査") return "milestone-circle";
            if (task.text === "出荷確認会議") return "milestone-diamond";
            if (task.text === "工場出荷") return "milestone-star";
            switch (task.major_item) {
                case '設計': return "task-blue";
                case '製管': case '品証': return "task-green";
                case '組立': return "task-yellow";
                case '電装': return "task-purple";
                case '操業': return "task-red";
                case '営業': return "task-orange";
                default: return "";
            }
        }

        async function fetchTasks() {
            // --- 現在の展開状態を記憶 ---
            const openTaskIds = new Set();
            gantt.eachTask(function(task) {
                if (task.open) openTaskIds.add(task.id);
            });

            // 表示モードに応じてソート順のカラムを切り替え
            const sortColumn = currentDisplayMode === 'machine' ? 'sort_order_machine' : 'sort_order';
            const { data, error } = await supabaseClient.from('tasks').select('*').order(sortColumn, { ascending: true });
            if (error) return;
            
            const rawTasks = data.map(t => ({
                id: t.id, text: t.text, start_date: t.start_date,
                duration: t.duration, owner: t.owner, project_number: (t.project_number || "").toString().trim(),
                machine: t.machine, unit: t.unit, major_item: t.major_item,
                sort_order: t.sort_order,
                sort_order_machine: t.sort_order_machine,
                parent_name: (t.parent || "").toString().trim(),
                customer_name: t.customer_name || "",
                project_details: t.project_details || ""
            }));

            // グローバルな allTasks を常に最新のデータで更新
            window.allTasks = rawTasks;

            const parentOrder = ["受注", "基本設計＆計画承認", "長納期品手配", "出図＆部品手配", "電気設計", "盤組立", "組立全体", "外観検査", "タスクリスト作成", "試運転", "客先立会", "出荷確認会議", "出荷準備", "出荷", "現地工事"];
            const tasksWithHierarchy = [];
            const parentsMap = {};

            const getPriority = (p) => {
                if (p.startsWith('2')) return 1;
                if (p.startsWith('3')) return 2;
                if (p.startsWith('4')) return 3;
                if (p.startsWith('D')) return 4;
                return 5;
            };
            const isPureNumeric = (s) => /^\d+$/.test(s);

            const projects = [...new Set(rawTasks.map(t => t.project_number))]
                .filter(Boolean)
                .sort((a, b) => {
                    const priA = getPriority(a);
                    const priB = getPriority(b);
                    if (priA !== priB) return priA - priB;
                    const numA = isPureNumeric(a);
                    const numB = isPureNumeric(b);
                    if (numA && !numB) return -1;
                    if (!numA && numB) return 1;
                    return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
                });

            if (currentDisplayMode === 'machine') {
                // 機械別：工事番号 -> 機械名 でまとめる
                projects.forEach(pNum => {
                    const projectTasks = rawTasks.filter(t => t.project_number === pNum);
                    // その工事に含まれる機械名を抽出
                    const machines = [...new Set(projectTasks.map(t => t.machine || "設定なし"))].sort();
                    
                    machines.forEach(mName => {
                        const tasksInMachine = projectTasks.filter(t => (t.machine || "設定なし") === mName);
                        if (tasksInMachine.length > 0) {
                            const parentKey = `p_${pNum}_m_${mName}`;
                            let minStart = null;
                            let maxEnd = null;
                            tasksInMachine.forEach(t => {
                                const start = new Date(t.start_date);
                                const end = gantt.calculateEndDate(start, t.duration);
                                if (!minStart || start < minStart) minStart = start;
                                if (!maxEnd || end > maxEnd) maxEnd = end;
                            });
                            
                            // 親行（工事番号 + 機械名）
                            if (!parentsMap[parentKey]) {
                                parentsMap[parentKey] = { 
                                    id: parentKey, 
                                    text: mName === "設定なし" ? pNum : `${pNum} - ${mName}`, 
                                    project_number: pNum, 
                                    machine: mName === "設定なし" ? "" : mName, 
                                    major_item: "", 
                                    customer_name: tasksInMachine[0].customer_name, 
                                    project_details: tasksInMachine[0].project_details, 
                                    start_date: minStart, 
                                    end_date: maxEnd, 
                                    open: openTaskIds.has(parentKey), // 記憶していた状態を反映
                                    type: "project", 
                                    $virtual: true 
                                };
                                tasksWithHierarchy.push(parentsMap[parentKey]);
                            }
                            // 子タスクを追加
                            tasksInMachine.forEach(t => { 
                                t.parent = parentKey; 
                                tasksWithHierarchy.push(t); 
                            });
                        }
                    });
                });
            } else {
                // 工程別（従来通り）：工事番号 -> 大項目（工程） でまとめる
                projects.forEach(pNum => {
                    const projectTasks = rawTasks.filter(t => t.project_number === pNum);
                    
                    // 定義済みの見出し（parentOrder）に含まれるタスクを処理
                    const assignedTaskIds = new Set();
                    parentOrder.forEach(pName => {
                        const tasksInParent = projectTasks.filter(t => t.parent_name === pName);
                        if (tasksInParent.length > 0) {
                            const parentKey = `p_${pNum}_${pName}`;
                            let minStart = null;
                            let maxEnd = null;
                            tasksInParent.forEach(t => {
                                assignedTaskIds.add(t.id);
                                const start = new Date(t.start_date);
                                const end = gantt.calculateEndDate(start, t.duration);
                                if (!minStart || start < minStart) minStart = start;
                                if (!maxEnd || end > maxEnd) maxEnd = end;
                            });
                            if (!parentsMap[parentKey]) {
                                parentsMap[parentKey] = { 
                                    id: parentKey, 
                                    text: pName, 
                                    project_number: pNum, 
                                    machine: tasksInParent[0].machine, 
                                    major_item: tasksInParent[0].major_item, 
                                    customer_name: tasksInParent[0].customer_name, 
                                    project_details: tasksInParent[0].project_details, 
                                    start_date: minStart, 
                                    end_date: maxEnd, 
                                    open: openTaskIds.has(parentKey), // 記憶していた状態を反映
                                    type: "project", 
                                    $virtual: true 
                                };
                                tasksWithHierarchy.push(parentsMap[parentKey]);
                            }
                            tasksInParent.forEach(t => { t.parent = parentKey; tasksWithHierarchy.push(t); });
                        }
                    });

                    // 見出し行がない（parentOrderに含まれない）タスクを「その他」または工事番号直下に表示
                    const unassignedTasks = projectTasks.filter(t => !assignedTaskIds.has(t.id));
                    if (unassignedTasks.length > 0) {
                        const parentKey = `p_${pNum}_other`;
                        let minStart = null;
                        let maxEnd = null;
                        unassignedTasks.forEach(t => {
                            const start = new Date(t.start_date);
                            const end = gantt.calculateEndDate(start, t.duration);
                            if (!minStart || start < minStart) minStart = start;
                            if (!maxEnd || end > maxEnd) maxEnd = end;
                        });
                        
                        if (!parentsMap[parentKey]) {
                            parentsMap[parentKey] = { 
                                id: parentKey, 
                                text: "", // タスク名（見出し名）の部分を空白に
                                project_number: pNum, 
                                machine: unassignedTasks[0].machine, 
                                major_item: "", 
                                customer_name: unassignedTasks[0].customer_name, 
                                project_details: unassignedTasks[0].project_details, 
                                start_date: minStart, 
                                end_date: maxEnd, 
                                open: openTaskIds.has(parentKey), // 記憶していた状態を反映
                                type: "project", 
                                $virtual: true 
                            };
                            tasksWithHierarchy.push(parentsMap[parentKey]);
                        }
                        unassignedTasks.forEach(t => { 
                            t.parent = parentKey; 
                            tasksWithHierarchy.push(t); 
                        });
                    }
                });
            }

            updateProjectList(rawTasks);
            gantt.clearAll();
            gantt.parse({ data: tasksWithHierarchy });
            gantt.config.start_date = new Date(GANTT_START_DATE.getTime());
            gantt.config.end_date = new Date(GANTT_END_DATE.getTime());
            gantt.render();
            scrollToToday();
            
            // リソース画面が表示されている場合は、最新の allTasks で再描画
            if (currentResourceOwnerFilter || currentResourceDeptFilter || currentLocationResourceMode) {
                updateResourceVisibility();
            }
        }

        function scrollToToday() {
            const pos = gantt.posFromDate(new Date());
            gantt.scrollTo(pos - 200, null);
        }

        function resetFilter() { location.reload(); }

        function setDisplayMode(mode) {
            currentDisplayMode = mode;
            document.getElementById('sort_process_btn').classList.toggle('active', mode === 'process');
            document.getElementById('sort_machine_btn').classList.toggle('active', mode === 'machine');
            
            // 列の更新
            updateGanttColumns();
            
            // データの再読み込みと再描画
            fetchTasks();
        }

        function updateGanttColumns() {
            const scrollState = gantt.getScrollState();
            if (currentDisplayMode === 'machine') {
                // 機械別：工事番号、機械、ユニット、タスク名、担当、開始日、終了日
                gantt.config.columns = [
                    { name: "project_number", label: "工事番号", width: COLUMN_WIDTHS[0], align: "center", template: function(obj) {
                        return obj.project_number || "";
                    }},
                    { name: "machine", label: "機械", width: COLUMN_WIDTHS[2], align: "center", template: function(obj) {
                        if (obj.$virtual) return "";
                        return obj.machine || "";
                    }},
                    { name: "unit", label: "ユニット", width: COLUMN_WIDTHS[3], align: "center", template: function(obj) {
                        if (obj.$virtual) return "";
                        return obj.unit || "";
                    }},
                    { name: "text", label: "タスク名", width: COLUMN_WIDTHS[1], tree: true, template: function(obj) {
                        return obj.text;
                    }},
                    { name: "owner", label: "担当", width: COLUMN_WIDTHS[4], align: "left", template: function(obj) {
                        if (obj.$virtual) return "";
                        if (!obj.owner || obj.owner.trim() === "") {
                            return "<span class='unassigned-warning'>⚠️</span>";
                        }
                        return obj.owner;
                    }},
                    { name: "start_date", label: "開始日", width: COLUMN_WIDTHS[5], align: "center", template: function(t) {
                        return dateToDisplay(t.start_date);
                    }},
                    { name: "end_date", label: "終了日", width: COLUMN_WIDTHS[6], align: "center", template: function(t) {
                        return dateToDisplay(gantt.calculateEndDate(t.start_date, t.duration));
                    }},
                    { name: "add", label: "", width: COLUMN_WIDTHS[7] }
                ];
            } else {
                // 工程別（デフォルト）：工事番号、タスク名、機械、ユニット、担当、開始日、終了日
                gantt.config.columns = SHARED_COLUMNS;
            }
            gantt.render();
            gantt.scrollTo(scrollState.x, scrollState.y);
        }

        function updateProjectList(tasks) {
            const listEl = document.getElementById('project_list');
            const projectInfoMap = {};
            tasks.forEach(t => { if (t.project_number && !projectInfoMap[t.project_number]) projectInfoMap[t.project_number] = { customer: t.customer_name || "", details: t.project_details || "" }; });
            const projects = Object.keys(projectInfoMap).sort();
            listEl.innerHTML = "";
            let tooltip = document.getElementById('custom_project_tooltip') || document.createElement('div');
            tooltip.id = 'custom_project_tooltip'; tooltip.className = 'custom-tooltip'; document.body.appendChild(tooltip);
            projects.forEach(p => {
                const item = document.createElement('div');
                item.className = `project-item ${currentFilter === p ? 'active' : ''}`;
                item.innerText = p;
                const info = projectInfoMap[p];
                if (info.customer || info.details) {
                    item.onmouseenter = (e) => {
                        tooltip.innerText = `${info.customer}\n${info.details}`.trim();
                        tooltip.style.display = 'block';
                        
                        // ボタンの位置を取得
                        const rect = item.getBoundingClientRect();
                        let x = rect.right + 10; // ボタンの右側に10pxの隙間
                        let y = rect.top;        // 基本はボタンの上端に合わせる
                        
                        // 画面下端で見切れる場合の調整
                        const tooltipHeight = tooltip.offsetHeight;
                        const windowHeight = window.innerHeight;
                        
                        if (y + tooltipHeight > windowHeight) {
                            // 下に見切れる場合は、吹き出しの下端が画面下から10pxの位置に来るように上げる
                            y = windowHeight - tooltipHeight - 10;
                        }
                        
                        tooltip.style.left = x + 'px';
                        tooltip.style.top = y + 'px';
                    };
                    item.onmouseleave = () => tooltip.style.display = 'none';
                }
                item.onclick = () => filterByProject(p);
                listEl.appendChild(item);
            });
        }

        function filterByProject(p) { 
            const scrollState = gantt.getScrollState();
            currentFilter = (currentFilter === p) ? null : p; 
            gantt.render(); 
            gantt.scrollTo(scrollState.x, scrollState.y);
            updateProjectList(window.allTasks); 
        }
        function filterByMajorItem(major, btn) { 
            const scrollState = gantt.getScrollState();
            currentMajorFilter = (currentMajorFilter === major) ? null : major; 
            document.querySelectorAll('.major-filter-btn').forEach(b => b.classList.toggle('active', b.innerText === major && currentMajorFilter)); 
            gantt.render(); 
            gantt.scrollTo(scrollState.x, scrollState.y);
        }
        async function filterByOwner(val) { 
            const scrollState = gantt.getScrollState();
            currentOwnerFilter = (val || "").trim(); 
            gantt.render(); 
            gantt.scrollTo(scrollState.x, scrollState.y);
        }
        function filterByMachine(val) { 
            const scrollState = gantt.getScrollState();
            currentMachineFilter = val; 
            gantt.render(); 
            gantt.scrollTo(scrollState.x, scrollState.y);
        }

        function toggleUnassignedFilter() {
            const btn = document.getElementById("unassigned_filter_btn");
            isUnassignedOnly = !isUnassignedOnly;
            
            if (isUnassignedOnly) {
                btn.classList.add("active");
            } else {
                btn.classList.remove("active");
            }
            
            gantt.render();
        }

        document.getElementById('resource_close_btn').addEventListener('click', closeResourcePanel);
        fetchTasks();
    </script>
</body>
</html>